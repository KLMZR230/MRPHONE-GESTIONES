<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cell Smar Gestion De Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /********************************/
        /* Estilos Base (Comunes a todos los temas) */
        /********************************/
        body {
            transition: background-color 0.5s ease;
        }
        .product-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover { transform: translateY(-5px); }
        #logo-upload { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; border: 0; }
        .view-section.hidden { display: none; }
        
        .skeleton-card { background-color: transparent; border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; }
        .skeleton-line {
            background-color: var(--bg-secondary);
            opacity: 0.7;
            border-radius: 0.25rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 50% { opacity: .4; } }

        /********************************/
        /* TEMA 1: Dark (Predeterminado) */
        /********************************/
        .theme-dark {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-header: rgba(31, 41, 55, 0.8);
            --text-primary: #e5e7eb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #818cf8;
            --accent-color-dark: #6366f1;
            --font-main: 'Poppins', sans-serif;
            --font-headings: 'Poppins', sans-serif;
        }

        /********************************/
        /* TEMA 2: Fuego Infernal */
        /********************************/
        .theme-infernal {
            --bg-primary: #000000;
            --bg-secondary: #2d1a1a;
            --bg-header: rgba(17, 7, 0, 0.6);
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #571e1e;
            --accent-color: #ff4500;
            --accent-color-dark: #e63e00;
            --font-main: 'Roboto', sans-serif;
            --font-headings: 'Roboto', sans-serif;
        }
        .theme-infernal { background-image: linear-gradient(180deg, #1a0000 0%, #000000 100%); }
        .theme-infernal .product-card:hover { box-shadow: 0 0 25px rgba(255, 69, 0, 0.5); border-color: rgba(255, 69, 0, 0.7); }

        /********************************/
        /* TEMA 3: Luxury Gold */
        /********************************/
        .theme-gold {
            --bg-primary: #121212;
            --bg-secondary: #2b2b2b;
            --bg-header: rgba(18, 18, 18, 0.85);
            --text-primary: #f1f1f1;
            --text-secondary: #cccccc;
            --text-muted: #a0a0a0;
            --border-color: #444444;
            --accent-color: #D4AF37;
            --accent-color-dark: #B8860B;
            --font-main: 'Poppins', sans-serif;
            --font-headings: 'Playfair Display', serif;
        }
        .theme-gold { background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        .theme-gold .product-card:hover { box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2); border-color: var(--accent-color); }
        .theme-gold .bg-indigo-500, .theme-gold .hover\:bg-indigo-600:hover { background: linear-gradient(145deg, #D4AF37, #B8860B); color: #121212; }
        .theme-gold .text-indigo-400, .theme-gold .text-indigo-300 { text-shadow: 0 0 8px #D4AF3788; }


        /********************************/
        /* Aplicación de Variables CSS */
        /********************************/
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-main);
        }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-headings); }

        .bg-gray-800, .bg-gray-900\/50 {
            background-color: var(--bg-header);
            border: 1px solid color-mix(in srgb, var(--border-color) 50%, transparent);
            backdrop-filter: blur(10px);
        }
        .text-gray-300 { color: var(--text-secondary); }
        .text-gray-400 { color: var(--text-muted); }
        .bg-gray-600 { background-color: var(--bg-secondary) !important; }
        .border-gray-500, .border-gray-600, .border-gray-700 { border-color: var(--border-color); }
        
        /* Acentos */
        .text-indigo-400, .text-indigo-300 { color: var(--accent-color); }
        .border-indigo-500 { border-color: var(--accent-color); }
        .bg-indigo-500 { background-color: var(--accent-color-dark); color: var(--text-primary); }
        .hover\:bg-indigo-600:hover { background-color: var(--accent-color); }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--accent-color); }
        input:focus, select:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 1px var(--accent-color);
            outline: none;
        }
        .bg-blue-600, .bg-green-600 { background-color: var(--accent-color-dark); }
        .hover\:bg-blue-700:hover, .hover\:bg-green-700:hover { background-color: var(--accent-color); }

        /********************************/
        /* ESTILOS FIJOS PARA ESTADOS DE VENTA */
        /********************************/
        .status-paid {
            background-color: #16a34a !important; /* Verde */
            color: #ffffff !important;
            border-color: #15803d !important;
        }
        .status-pending {
            background-color: #f59e0b !important; /* Naranja/Amarillo */
            color: #1f2937 !important;
            border-color: #d97706 !important;
        }
        .status-returned {
            background-color: #dc2626 !important; /* Rojo */
            color: #ffffff !important;
            border-color: #b91c1c !important;
        }
    </style>

    <script>
        (function() {
            try {
                const theme = localStorage.getItem('selectedTheme');
                if (theme && ['theme-dark', 'theme-infernal', 'theme-gold'].includes(theme)) {
                    document.documentElement.className = theme; // Aplicar al <html> para máxima prioridad
                } else {
                    document.documentElement.className = 'theme-dark'; // Fallback
                }
            } catch (e) {
                document.documentElement.className = 'theme-dark';
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    </head>
<body class=""> <header class="sticky top-0 z-10 bg-gray-800 shadow-lg p-4 flex items-center justify-between border-b border-gray-700">
        <div class="flex items-center space-x-4">
            <img id="business-logo" src="https://via.placeholder.com/60/4f46e5/ffffff?text=CS" alt="Logo negocio" class="h-12 w-12 object-cover rounded-full border-2 border-indigo-500 shadow-md transition transform hover:scale-105" />
            <h1 class="text-3xl font-extrabold tracking-tight">
                📱 <span class="text-indigo-400">Cell Smar</span> Gestion De Ventas
            </h1>
        </div>
        
        <div class="flex items-center space-x-4">
            <div id="view-buttons" class="flex items-center space-x-2 bg-black/20 p-1 rounded-lg border border-gray-700">
                 <button data-view="inventory" class="view-btn bg-indigo-500 text-white font-medium py-1.5 px-3 rounded-lg text-sm shadow-md transition duration-300">📦 Inventario</button>
                 <button data-view="inventory_el_transito" class="view-btn bg-transparent text-gray-300 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-300 text-sm">🚚 Inventario El Transito</button>
                 <button data-view="sales" class="view-btn bg-transparent text-gray-300 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-300 text-sm">💰 Ventas</button>
                 <button data-view="sales_el_transito" class="view-btn bg-transparent text-gray-300 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-300 text-sm">🚚 Ventas El Transito</button>
                 <button data-view="missing" class="view-btn bg-transparent text-gray-300 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-300 text-sm">🔔 Faltantes</button>
            </div>
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <label for="theme-selector" class="text-sm text-gray-400">Tema:</label>
                    <select id="theme-selector" class="bg-gray-600 border border-gray-500 text-white text-sm rounded-lg p-1.5">
                        <option value="theme-dark">Predeterminado</option>
                        <option value="theme-infernal">Fuego Infernal</option>
                        <option value="theme-gold">Luxury Gold</option>
                    </select>
                </div>
                <label for="logo-upload" class="bg-indigo-500 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 transition duration-300 cursor-pointer text-sm shadow-sm">Logo 🖼️</label>
                <input type="file" id="logo-upload" title="Sube una nueva imagen para tu logo" accept="image/*" />
                <button id="logo-save-button" class="bg-green-500 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-green-600 transition duration-300 shadow-md disabled:bg-gray-500 disabled:cursor-not-allowed text-sm" disabled>Guardar</button>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-6">
        <p class="text-gray-300 mb-6" id="current-view-title">Vista: Inventario</p>
        
        <div id="inventory-view" class="view-section">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">➕ Agregar producto</h2>
                <form id="product-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-300">Nombre</label><input id="name" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Flex de Botones" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Categoría</label><select id="category-select" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white"><option value="">Seleccionar</option><option value="Pantallas">Pantallas</option><option value="Jacks de Carga">Jacks de Carga</option><option value="Flex Main">Flex Main</option><option value="Placas de Carga">Placas de Carga</option><option value="Botones Fisicos">Botones Fisicos</option><option value="Botones Internos">Botones Internos</option><option value="Accesorios">Accesorios</option><option value="Otros">Otros</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-300">Precio (USD)</label><input id="price" type="number" step="0.01" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="12.50" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Cantidad</label><input id="quantity" type="number" min="0" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Imagen</label><input id="image" type="file" accept="image/*" class="mt-1 block w-full p-1 border rounded-md bg-gray-600 border-gray-500 text-white" /></div>
                    <div class="md:col-span-5 text-right"><button id="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">Agregar Producto</button></div>
                </form>
                <p id="status" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-semibold text-indigo-300">📦 Inventario por Categoría</h2><span id="total-count" class="text-gray-400 text-sm"></span></div>
                <div class="mb-6 flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><input type="text" id="search-input" placeholder="Buscar por nombre o categoría..." class="p-2 border rounded-md w-full max-w-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 border-gray-600 text-white" /></div>
                <div id="products-loader" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="products"></div>
            </section>
        </div>

        <div id="inventory-el-transito-view" class="view-section hidden">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">➕ Agregar producto (El Transito)</h2>
                <form id="product-form-et" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-300">Nombre</label><input id="name-et" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Flex de Botones" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Categoría</label><select id="category-select-et" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white"><option value="">Seleccionar</option><option value="Pantallas">Pantallas</option><option value="Jacks de Carga">Jacks de Carga</option><option value="Flex Main">Flex Main</option><option value="Placas de Carga">Placas de Carga</option><option value="Botones Fisicos">Botones Fisicos</option><option value="Botones Internos">Botones Internos</option><option value="Accesorios">Accesorios</option><option value="Otros">Otros</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-300">Precio (USD)</label><input id="price-et" type="number" step="0.01" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="12.50" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Cantidad</label><input id="quantity-et" type="number" min="0" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Imagen</label><input id="image-et" type="file" accept="image/*" class="mt-1 block w-full p-1 border rounded-md bg-gray-600 border-gray-500 text-white" /></div>
                    <div class="md:col-span-5 text-right"><button id="submit-et" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">Agregar Producto</button></div>
                </form>
                <p id="status-et" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-semibold text-indigo-300">🚚 Inventario El Transito</h2><span id="total-count-et" class="text-gray-400 text-sm"></span></div>
                <div class="mb-6 flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><input type="text" id="search-input-et" placeholder="Buscar por nombre o categoría..." class="p-2 border rounded-md w-full max-w-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 border-gray-600 text-white" /></div>
                <div id="products-loader-et" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="products-et"></div>
            </section>
        </div>

        <div id="sales-view" class="view-section hidden">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">💸 Registrar Venta</h2>
                <form id="sale-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-300">Producto</label><input id="sale-product-name" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Pantalla Samsung A12" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Cantidad</label><input id="sale-quantity" type="number" min="1" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Total Venta (USD)</label><input id="sale-total" type="number" step="0.01" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="25.00" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Fecha</label><input id="sale-date" type="date" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Estado</label><select id="sale-status" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white"><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option><option value="Devolución">Devolución</option></select></div>
                    <div class="md:col-span-5 text-right"><button id="sale-submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Registrar Venta</button></div>
                </form>
                <p id="sale-status-message" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">🧾 Historial de Ventas</h2>
                <div class="mb-6 flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><input type="text" id="sales-search-input" placeholder="Buscar venta..." class="p-2 border rounded-md w-full max-w-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 border-gray-600 text-white" /></div>
                <div id="sales-data" class="space-y-4"></div>
            </section>
        </div>

        <div id="sales-el-transito-view" class="view-section hidden">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">💸 Registrar Venta (El Transito)</h2>
                <form id="sale-form-et" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-300">Producto</label><input id="sale-product-name-et" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Pantalla Samsung A12" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Cantidad</label><input id="sale-quantity-et" type="number" min="1" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Total Venta (USD)</label><input id="sale-total-et" type="number" step="0.01" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="25.00" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Fecha</label><input id="sale-date-et" type="date" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Estado</label><select id="sale-status-et" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white"><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option><option value="Devolución">Devolución</option></select></div>
                    <div class="md:col-span-5 text-right"><button id="sale-submit-et" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Registrar Venta</button></div>
                </form>
                <p id="sale-status-message-et" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">🧾 Historial de Ventas (El Transito)</h2>
                <div class="mb-6 flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><input type="text" id="sales-search-input-et" placeholder="Buscar venta..." class="p-2 border rounded-md w-full max-w-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 border-gray-600 text-white" /></div>
                <div id="sales-data-et" class="space-y-4"></div>
            </section>
        </div>

        <div id="missing-view" class="view-section hidden">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">📝 Agregar Producto Faltante</h2>
                <form id="missing-product-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-gray-300">Nombre del Producto</label><input id="missing-product-name" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Pantalla iPhone 11" /></div>
                    <div><label class="block text-sm font-medium text-gray-300">Cantidad Solicitada</label><input id="missing-product-quantity" type="number" min="1" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" /></div>
                    <div class="md:col-span-3 text-right"><button id="missing-product-submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow">Añadir a Faltantes</button></div>
                </form>
                <p id="missing-product-status" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">🚨 Lista de Productos Faltantes</h2>
                <div id="missing-products-data" class="space-y-4"></div>
            </section>
        </div>
    </div>

    <script>
        // Placeholder para el cliente de Supabase (asume que está inicializado en la cabecera)
        // Ejemplo: const supabase = window.supabase;
        
        // Variables globales para la gestión de vistas
        const views = {
            'inventory': document.getElementById('inventory-view'),
            'inventory_el_transito': document.getElementById('inventory-el-transito-view'),
            'sales': document.getElementById('sales-view'),
            'sales_el_transito': document.getElementById('sales-el-transito-view'),
            'missing': document.getElementById('missing-view')
        };
        const viewButtons = document.querySelectorAll('.view-btn');
        const currentViewTitle = document.getElementById('current-view-title');
        
        function toggleView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('hidden', key !== viewName);
            });
            viewButtons.forEach(btn => {
                const isActive = btn.dataset.view === viewName;
                btn.classList.toggle('bg-indigo-500', isActive);
                btn.classList.toggle('bg-transparent', !isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('text-gray-300', !isActive);
            });
            const viewText = viewName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            currentViewTitle.textContent = `Vista: ${viewText}`;
        }

        // --- FUNCIONES DE CÁTEDRA (Asume que están definidas o vacías) ---
        function fetchProducts() { return Promise.resolve(); }
        function fetchProductsET() { return Promise.resolve(); }
        function fetchSales() { return Promise.resolve(); }
        function fetchSalesElTransito() { return Promise.resolve(); }
        function fetchMissingProducts() { return Promise.resolve(); }
        function showSkeletonLoaders() {}
        function setStatusMessage(element, message, success) {
            element.textContent = message;
            element.className = success ? 'text-green-400 mt-3' : 'text-red-400 mt-3';
            setTimeout(() => { element.textContent = ''; }, 5000);
        }

        // ----------------------------------------------------------------------------------
        // --- CÓDIGO CORREGIDO PARA LA SUBIDA Y VISUALIZACIÓN DEL LOGO (EL ARREGLO) ---
        // ----------------------------------------------------------------------------------
        const logoInput = document.getElementById('logo-upload');
        const logoSaveButton = document.getElementById('logo-save-button');
        const businessLogoImg = document.getElementById('business-logo');
        
        // Variable para guardar el archivo temporalmente
        let businessLogoFile = null;

        /**
         * FUNCIÓN CLAVE CORREGIDA: Carga el logo aplicando cache-busting.
         * La URL del logo se guarda en localStorage como 'businessLogoUrl'.
         */
        function loadLogo() {
            const defaultLogo = businessLogoImg.src;
            let logoUrl = localStorage.getItem('businessLogoUrl');

            if (logoUrl) {
                // CORRECCIÓN: Agregar un parámetro de consulta de tiempo (timestamp)
                // para que el navegador sepa que la imagen ha cambiado y no use la versión cacheada.
                const cacheBuster = Date.now();
                logoUrl = `${logoUrl.split('?')[0]}?t=${cacheBuster}`;
                businessLogoImg.src = logoUrl;
            } else {
                businessLogoImg.src = defaultLogo;
            }
        }

        /**
         * Guarda el logo en Supabase Storage (Asume un bucket 'logos' y ruta fija).
         */
        async function saveLogo() {
            if (!businessLogoFile) return;

            // Deshabilitar botón para evitar clics múltiples
            logoSaveButton.disabled = true;
            logoSaveButton.textContent = 'Guardando...';

            // Ruta donde se guardará el logo (se usa una ruta fija para sobrescribir)
            const filePath = 'public/business_logo.png';
            const bucketName = 'logos'; // Reemplaza con el nombre de tu bucket
            
            try {
                // 1. Subir/Actualizar el archivo en Supabase Storage
                // Se usa upsert: true para sobrescribir el archivo existente
                const { data, error } = await supabase.storage
                    .from(bucketName)
                    .upload(filePath, businessLogoFile, {
                        cacheControl: '3600', // Tiempo de vida del caché en la CDN
                        upsert: true // Sobrescribir el archivo si ya existe
                    });

                if (error) throw error;
                
                // 2. Obtener la URL pública del archivo
                const { data: publicUrlData } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(filePath);

                if (!publicUrlData || !publicUrlData.publicUrl) {
                    throw new Error("No se pudo generar la URL pública.");
                }

                // 3. Guardar la URL pública en localStorage para persistencia
                localStorage.setItem('businessLogoUrl', publicUrlData.publicUrl);
                
                // 4. Cargar el logo con la función corregida (con cache-busting)
                loadLogo(); 
                
                // Limpiar estado
                businessLogoFile = null;
                logoInput.value = '';
                logoSaveButton.textContent = 'Guardado ✅';
                setTimeout(() => { logoSaveButton.textContent = 'Guardar'; }, 3000);

            } catch (error) {
                console.error('Error al subir el logo:', error.message);
                logoSaveButton.textContent = 'Error al Guardar ❌';
                // Volver a habilitar si el error no fue grave
                setTimeout(() => { logoSaveButton.textContent = 'Guardar'; logoSaveButton.disabled = false; }, 3000);
            } finally {
                 if (businessLogoFile === null) {
                    logoSaveButton.disabled = true;
                }
            }
        }

        // Evento para previsualizar el logo y habilitar el botón de guardar
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                businessLogoFile = file;
                logoSaveButton.disabled = false;
                logoSaveButton.textContent = 'Guardar';

                // Previsualización inmediata usando FileReader
                const reader = new FileReader();
                reader.onload = (e) => {
                    businessLogoImg.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                businessLogoFile = null;
                logoSaveButton.disabled = true;
            }
        });

        // Evento para guardar el logo
        logoSaveButton.addEventListener('click', saveLogo);
        // ----------------------------------------------------------------------------------

        // --- LÓGICA DE INICIALIZACIÓN (Sin modificar) ---
        const themeSelector = document.getElementById('theme-selector');
        const root = document.documentElement;
        const saleDateIn = document.getElementById('sale-date');
        const saleDateInET = document.getElementById('sale-date-et');

        // Asume que estas funciones están definidas en otro lugar o son placeholders
        const productForm = document.getElementById('product-form');
        const productFormET = document.getElementById('product-form-et');
        const saleForm = document.getElementById('sale-form');
        const saleFormET = document.getElementById('sale-form-et');
        const missingProductForm = document.getElementById('missing-product-form');
        const missingProductSubmitBtn = document.getElementById('missing-product-submit');
        const missingProductStatus = document.getElementById('missing-product-status');

        themeSelector.addEventListener('change', (e) => {
            const newTheme = e.target.value;
            root.className = newTheme;
            localStorage.setItem('selectedTheme', newTheme);
        });

        // Placeholder para formularios (asegura que no haya errores si no están implementados)
        productForm && productForm.addEventListener('submit', (e) => e.preventDefault());
        productFormET && productFormET.addEventListener('submit', (e) => e.preventDefault());
        saleForm && saleForm.addEventListener('submit', (e) => e.preventDefault());
        saleFormET && saleFormET.addEventListener('submit', (e) => e.preventDefault());
        missingProductForm && missingProductForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             // Lógica de Supabase Missing Products (Placeholder)
             setStatusMessage(missingProductStatus, "Función Faltantes no implementada", false);
        });
        
        document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', () => toggleView(btn.dataset.view)));
        
        window.addEventListener("load", async () => {
            // Sincronizar el selector con el tema ya aplicado por el script del <head>
            themeSelector.value = root.className;

            // Configurar valores iniciales
            saleDateIn && (saleDateIn.value = new Date().toISOString().split('T')[0]);
            saleDateInET && (saleDateInET.value = new Date().toISOString().split('T')[0]);
            toggleView('inventory');
            showSkeletonLoaders();
            
            // Cargar logo (LA FUNCIÓN CORREGIDA SE LLAMA AQUÍ)
            loadLogo(); 
            
            // Ejecutar todas las cargas de datos en paralelo para mayor fluidez
            try {
                await Promise.all([
                    fetchProducts(), 
                    fetchProductsET(),
                    fetchSales(), 
                    fetchSalesElTransito(),
                    fetchMissingProducts()
                ]);
            } catch (error) {
                console.error("Error durante la carga de datos inicial:", error);
            }
        });
    </script>
</body>
</html>
