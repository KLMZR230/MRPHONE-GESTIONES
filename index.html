<!DOCTYPE html>
<html lang="es" class="theme-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRPHONE PRODUCTOS Y VENTAS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        (function() {
            try {
                const theme = localStorage.getItem('selectedTheme');
                if (theme && ['theme-dark', 'theme-infernal', 'theme-gold'].includes(theme)) {
                    document.documentElement.className = theme;
                } else {
                    document.documentElement.className = 'theme-dark';
                }
            } catch (e) {
                document.documentElement.className = 'theme-dark';
            }
        })();
    </script>

    <style>
        body { transition: background-color 0.5s ease; }
        .product-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover { transform: translateY(-5px); }
        .view-section.hidden { display: none; }
        
        .skeleton-card { background-color: var(--bg-secondary); opacity: 0.5; border-radius: 0.5rem; padding: 1rem; }
        .skeleton-line { background-color: var(--bg-primary); opacity: 0.8; border-radius: 0.25rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .6; } }

        .theme-dark {
            --bg-primary: #1f2937; --bg-secondary: #374151; --bg-header: rgba(31, 41, 55, 0.8);
            --text-primary: #e5e7eb; --text-secondary: #d1d5db; --text-muted: #9ca3af;
            --border-color: #4b5563; --accent-color: #818cf8; --accent-color-dark: #6366f1;
            --font-main: 'Poppins', sans-serif; --font-headings: 'Poppins', sans-serif;
        }

        .theme-infernal {
            --bg-primary: #000000; --bg-secondary: #2d1a1a; --bg-header: rgba(17, 7, 0, 0.6);
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-muted: #9ca3af;
            --border-color: #571e1e; --accent-color: #ff4500; --accent-color-dark: #e63e00;
            --font-main: 'Roboto', sans-serif; --font-headings: 'Roboto', sans-serif;
        }
        .theme-infernal body { background-image: linear-gradient(180deg, #1a0000 0%, #000000 100%); }
        .theme-infernal .product-card:hover { box-shadow: 0 0 25px rgba(255, 69, 0, 0.5); border-color: rgba(255, 69, 0, 0.7); }

        .theme-gold {
            --bg-primary: #121212; --bg-secondary: #2b2b2b; --bg-header: rgba(18, 18, 18, 0.85);
            --text-primary: #f1f1f1; --text-secondary: #cccccc; --text-muted: #a0a0a0;
            --border-color: #444444; --accent-color: #D4AF37; --accent-color-dark: #B8860B;
            --font-main: 'Poppins', sans-serif; --font-headings: 'Playfair Display', serif;
        }
        .theme-gold body { background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        .theme-gold .product-card:hover { box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2); border-color: var(--accent-color); }
        .theme-gold .bg-indigo-500, .theme-gold .hover\:bg-indigo-600:hover { background: linear-gradient(145deg, #D4AF37, #B8860B); color: #121212; }
        .theme-gold .text-indigo-400, .theme-gold .text-indigo-300 { text-shadow: 0 0 8px #D4AF3788; }

        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-main); }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-headings); }
        .bg-gray-800, .bg-gray-900\/50 { background-color: var(--bg-header); border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        .text-gray-300 { color: var(--text-secondary); }
        .text-gray-400 { color: var(--text-muted); }
        .bg-gray-600, input, select { background-color: var(--bg-secondary) !important; }
        .border-gray-500, .border-gray-600, .border-gray-700, input, select { border-color: var(--border-color); }
        .text-indigo-400, .text-indigo-300 { color: var(--accent-color); }
        .border-indigo-500 { border-color: var(--accent-color); }
        .bg-indigo-500 { background-color: var(--accent-color-dark); color: var(--text-primary); }
        .hover\:bg-indigo-600:hover { background-color: var(--accent-color); }
        input:focus, select:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 1px var(--accent-color); outline: none; }
        .bg-blue-600, .bg-green-600, button[type="submit"] { background-color: var(--accent-color-dark); }
        .hover\:bg-blue-700:hover, .hover\:bg-green-700:hover, button[type="submit"]:hover { background-color: var(--accent-color); }

        .status-paid { background-color: #16a34a !important; color: #ffffff !important; border-color: #15803d !important; }
        .status-pending { background-color: #f59e0b !important; color: #1f2937 !important; border-color: #d97706 !important; }
        .status-returned { background-color: #dc2626 !important; color: #ffffff !important; border-color: #b91c1c !important; }

        #store-logo-img { cursor: pointer; object-fit: contain; }
        #store-logo-container { width: 150px; height: 60px; display: flex; align-items: center; justify-content: center; margin-right: 1.5rem; flex-shrink: 0; }
        select.status-select option { background-color: #374151; }
        .active-nav { background-color: var(--accent-color-dark) !important; color: var(--text-primary) !important; border-radius: 0.5rem; }
        
        .themed-border {
            border: 2px solid var(--accent-color) !important;
            box-shadow: 0 0 8px -2px var(--accent-color);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <input type="file" id="logo-file-input" class="hidden" accept="image/*">

    <div id="app" class="flex-grow p-4 md:p-8">
        <header class="sticky top-0 z-10 bg-gray-800 shadow-lg p-4 flex items-center justify-between mb-6 rounded-xl themed-border">
             <div class="flex items-center space-x-4">
                 <div id="store-logo-container" title="Haz clic para cambiar el logo"><img id="store-logo-img" src="https://placehold.co/240x80/1f2937/d97706?text=MRPHONE" alt="Store Logo" class="h-full w-full object-cover rounded-full border-2 border-indigo-500 shadow-md transition transform hover:scale-105"></div>
                 <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight"><span class="text-indigo-400">MRPHONE</span> PRODUCTOS</h1>
             </div>
             <div class="flex items-center space-x-4">
                <div id="daily-sales-summary" class="flex items-center space-x-4 text-sm bg-gray-900/50 p-2 rounded-lg"><p>Vendido HOY: <span id="today-sold-total" class="font-bold text-green-400">$0.00</span></p><p>Pagado HOY: <span id="today-paid-total" class="font-bold text-green-500">$0.00</span></p><p class="pr-2 border-r border-gray-600">Gastos HOY: <span id="today-expenses-total" class="font-bold text-red-400">$0.00</span></p></div>
                 <div class="flex items-center space-x-2"><label for="theme-selector" class="text-sm text-gray-400">Tema:</label><select id="theme-selector" class="bg-gray-600 border border-gray-500 text-white text-sm rounded-lg p-1.5"><option value="theme-dark">Predeterminado</option><option value="theme-infernal">Fuego Infernal</option><option value="theme-gold">Luxury Gold</option></select></div>
             </div>
        </header>

        <nav class="flex justify-around space-x-2 p-1 rounded-lg border border-gray-700 bg-black/20 mb-6"><button onclick="changeView('inventory')" id="nav-inventory" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">游닍 Inventario</button><button onclick="changeView('sales')" id="nav-sales" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">游눯 Registrar Venta</button><button onclick="changeView('expenses')" id="nav-expenses" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">游눶 Gastos</button><button onclick="changeView('history')" id="nav-history" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">游늵 Historial Ventas</button><button onclick="changeView('local2')" id="nav-local2" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">游뚴 LOCAL 2</button></nav>

        <main>
            <div id="error-message" class="text-center p-4 bg-red-900/50 text-red-300 rounded-lg shadow-md hidden"></div>
            <section id="view-inventory" class="view-content hidden"><div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8 themed-border"><h2 class="text-2xl font-bold mb-4 text-indigo-300">Inventario Principal</h2><div class="flex flex-col md:flex-row justify-between md:items-center"><div class="relative w-full md:w-72 mb-4 md:mb-0"><input type="text" id="search-inventory" placeholder="Buscar producto..." class="w-full rounded-lg text-white shadow-sm p-3 pl-10 border"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div><button onclick="openAddProductModal('local1')" class="px-4 py-3 rounded-lg font-bold transition-colors shadow-lg whitespace-nowrap bg-blue-600 hover:bg-blue-700 text-white">A침adir Nuevo Producto</button></div></div><div id="inventory-list" class="space-y-8"></div></section>
            <section id="view-sales" class="view-content hidden"><div class="max-w-xl mx-auto p-6 bg-gray-800 rounded-xl shadow-xl themed-border"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Registrar Venta</h2><form id="record-sale-form" class="space-y-4"><div><label for="sale-category" class="block text-sm font-medium">Categor칤a</label><select id="sale-category" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"><option value="" disabled selected>Primero selecciona</option></select></div><div><label for="sale-product-id" class="block text-sm font-medium">Producto</label><select id="sale-product-id" required disabled class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border disabled:opacity-50"><option value="" disabled selected>Selecciona</option></select></div><div><label for="sale-quantity" class="block text-sm font-medium">Cantidad</label><input type="number" id="sale-quantity" required min="1" step="1" value="1" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="sale-recipient" class="block text-sm font-medium">Cliente</label><input type="text" id="sale-recipient" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="sale-price" class="block text-sm font-medium">Precio ($)</label><input type="number" id="sale-price" required min="0.01" step="0.01" value="0.00" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="sale-status" class="block text-sm font-medium">Estado</label><select id="sale-status" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option></select></div><button type="submit" class="w-full text-white p-3 rounded-lg font-bold transition-colors shadow-lg">Confirmar Venta</button></form></div></section>
            <section id="view-expenses" class="view-content hidden"><div class="grid grid-cols-1 lg:grid-cols-5 gap-8"><div class="lg:col-span-2"><div class="p-6 bg-gray-800 rounded-xl shadow-xl themed-border"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Registrar Gasto</h2><form id="record-expense-form" class="space-y-4"><div><label for="expense-description" class="block text-sm font-medium">Descripci칩n</label><input type="text" id="expense-description" required placeholder="Ej: Alquiler, Salario" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="expense-amount" class="block text-sm font-medium">Monto ($)</label><input type="number" id="expense-amount" required min="0.01" step="0.01" value="0.00" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><button type="submit" class="w-full text-white p-3 rounded-lg font-bold transition-colors shadow-lg">Confirmar Gasto</button></form></div></div><div class="lg:col-span-3"><div class="p-6 bg-gray-800 rounded-xl shadow-xl"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Historial de Gastos</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead><tr class="bg-gray-700/50"><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Descripci칩n</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Monto</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Acciones</th></tr></thead><tbody id="expenses-history-body" class="bg-gray-800 divide-y divide-gray-700"></tbody></table></div></div></div></div></section>
            <section id="view-history" class="view-content hidden"><div class="p-6 bg-gray-800 rounded-xl shadow-xl"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Historial de Ventas</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead><tr class="bg-gray-700/50"><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Producto</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Destinatario</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Precio</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Acciones</th></tr></thead><tbody id="sales-history-body" class="bg-gray-800 divide-y divide-gray-700"></tbody></table></div></div></section>
            <section id="view-local2" class="view-content hidden"><nav class="flex justify-center space-x-2 p-1 rounded-lg border border-gray-700 bg-black/20 mb-6"><button onclick="changeSubView('local2-inventory')" id="nav-local2-inventory" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">Inventario</button><button onclick="changeSubView('local2-sales')" id="nav-local2-sales" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">Venta</button><button onclick="changeSubView('local2-history')" id="nav-local2-history" class="py-1.5 px-3 font-medium text-center transition-all duration-200 text-gray-300 hover:text-white rounded-lg text-sm w-full">Historial</button></nav><div id="subview-local2-inventory" class="subview-content"><div class="p-6 bg-gray-800 rounded-xl shadow-xl themed-border"><div class="flex flex-col md:flex-row justify-between md:items-center mb-6"><h2 class="text-2xl font-bold mb-4 md:mb-0 text-indigo-300">Inventario Local 2</h2><button onclick="openAddProductModal('local2')" class="px-4 py-3 rounded-lg font-bold transition-colors shadow-lg whitespace-nowrap bg-blue-600 hover:bg-blue-700 text-white">A침adir Producto</button></div><div id="inventory-list-2" class="space-y-8"></div></div></div><div id="subview-local2-sales" class="subview-content hidden"><div class="max-w-xl mx-auto p-6 bg-gray-800 rounded-xl shadow-xl"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Registrar Venta (Local 2)</h2><form id="record-sale-form-2" class="space-y-4"><div><label for="sale-category-2" class="block text-sm font-medium">Categor칤a</label><select id="sale-category-2" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"><option value="" disabled selected>Selecciona</option></select></div><div><label for="sale-product-id-2" class="block text-sm font-medium">Producto</label><select id="sale-product-id-2" required disabled class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border disabled:opacity-50"><option value="" disabled selected>Selecciona</option></select></div><button type="submit" class="w-full text-white p-3 rounded-lg font-bold transition-colors shadow-lg">Confirmar Venta</button></form></div></div><div id="subview-local2-history" class="subview-content hidden"><div class="p-6 bg-gray-800 rounded-xl shadow-xl"><h2 class="text-2xl font-bold mb-6 text-indigo-300">Historial (Local 2)</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead><tr class="bg-gray-700/50"><th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Producto</th></tr></thead><tbody id="sales-history-body-2" class="bg-gray-800 divide-y divide-gray-700"></tbody></table></div></div></div></section>
        </main>
    </div>
    
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden"><div id="modal-content" class="p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all bg-gray-800 themed-border"><h3 id="modal-title" class="text-xl font-bold mb-3 text-indigo-300"></h3><p id="modal-body" class="mb-4"></p><div class="flex flex-col space-y-2 pt-4"><button id="modal-button" class="w-full py-2 rounded-lg font-semibold transition-colors"></button><button id="modal-cancel-button" onclick="closeModal()" class="w-full py-2 rounded-lg font-semibold border transition-colors hidden" style="border-color: var(--border-color);">Cancelar</button></div></div></div>
    <div id="edit-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden"><div class="p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all bg-gray-800 themed-border"><h3 class="text-2xl font-bold mb-4 text-indigo-300">Editar Producto</h3><form id="edit-product-form" class="space-y-4"><input type="hidden" id="edit-product-id"><input type="hidden" id="edit-product-location"><div class="flex flex-col items-center space-y-3"><label for="edit-product-image-file" class="relative cursor-pointer group" title="Cambiar imagen"><img id="edit-product-image-preview" src="https://placehold.co/150x150/1f2937/d97706?text=IMG" alt="Vista previa" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-700"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center rounded-lg transition-opacity"><svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div></label><input type="file" id="edit-product-image-file" accept="image/*" class="hidden"><p class="text-xs text-gray-400">Clic en la imagen para cambiarla (m치x 500KB)</p></div><div><label for="edit-product-name" class="block text-sm font-medium">Nombre</label><input type="text" id="edit-product-name" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="edit-product-category" class="block text-sm font-medium">Categor칤a</label><select id="edit-product-category" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"><option value="Flex Main">Flex Main</option><option value="Pantallas">Pantallas</option><option value="Jacks De Carga">Jacks De Carga</option><option value="Otro">Otro</option></select></div><div><label for="edit-product-price" class="block text-sm font-medium">Precio ($)</label><input type="number" id="edit-product-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="edit-product-quantity" class="block text-sm font-medium">Cantidad</label><input type="number" id="edit-product-quantity" required min="0" step="1" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div class="flex space-x-4 pt-4"><button type="button" onclick="closeEditModal()" class="flex-1 py-2 rounded-lg font-semibold border transition-colors" style="color: var(--accent-color); border-color: var(--accent-color);">Cancelar</button><button type="submit" class="flex-1 p-3 rounded-lg font-bold shadow-lg">Guardar</button></div></form></div></div>
    <div id="add-product-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden"><div class="p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all bg-gray-800 themed-border"><h3 class="text-2xl font-bold mb-4 text-indigo-300">A침adir Nuevo Producto</h3><form id="add-product-form-modal" class="space-y-4"><input type="hidden" id="add-product-location"><div><label for="product-name-modal" class="block text-sm font-medium">Nombre</label><input type="text" id="product-name-modal" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="product-category-modal" class="block text-sm font-medium">Categor칤a</label><select id="product-category-modal" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"><option value="" disabled selected>Selecciona</option><option value="Flex Main">Flex Main</option><option value="Pantallas">Pantallas</option><option value="Jacks De Carga">Jacks De Carga</option><option value="Otro">Otro</option></select></div><div><label for="product-price-initial-modal" class="block text-sm font-medium">Precio ($)</label><input type="number" id="product-price-initial-modal" required min="0.01" step="0.01" value="1.00" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="product-quantity-modal" class="block text-sm font-medium">Cantidad</label><input type="number" id="product-quantity-modal" required min="1" value="1" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border"></div><div><label for="product-image-file-modal" class="block text-sm font-medium">Foto (Opcional)</label><input type="file" id="product-image-file-modal" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold"></div><div class="flex space-x-4 pt-4"><button type="button" onclick="closeAddProductModal()" class="flex-1 py-2 rounded-lg font-semibold border transition-colors" style="color: var(--accent-color); border-color: var(--accent-color);">Cancelar</button><button type="submit" class="flex-1 p-3 rounded-lg font-bold shadow-lg">Guardar</button></div></form></div></div>
    <div id="image-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden" onclick="closeImageModal()"><button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 transition-colors">&times;</button><img id="image-modal-content" src="" alt="Producto Ampliado" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()"></div>

<script type="module">
    const supabaseUrl = 'https://osqrggvtthczsxoovyps.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zcXJnZ3Z0dGhjenN4b292eXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDQ2OTUsImV4cCI6MjA3NTQ4MDY5NX0.yvCMoyMhuHkuKB_uA1P33rSC7U30MnixgTQNIEEp-dQ';
    
    let supabase = null; 
    let inventory = [], salesHistory = [], expensesHistory = [];
    let inventory2 = [], salesHistory2 = [];
    const PUBLIC_STORE_ID = 'public_store_id_mrphone'; 
    let currentUserId = null; 

    window.changeTheme = (theme) => { document.documentElement.className = theme; localStorage.setItem('selectedTheme', theme); };
    window.closeModal = () => document.getElementById('modal-container').classList.add('hidden');
    window.closeImageModal = () => document.getElementById('image-modal-container').classList.add('hidden');
    window.closeEditModal = () => document.getElementById('edit-modal-container').classList.add('hidden');
    window.closeAddProductModal = () => { document.getElementById('add-product-modal-container').classList.add('hidden'); document.getElementById('add-product-form-modal').reset(); };
    window.handleStatusChange = async (selectElement, saleId, location = 'local1') => await updateSaleStatus(saleId, selectElement.value, location);
    window.filterInventory = () => renderInventoryList(inventory, 'inventory-list', 'local1', document.getElementById('search-inventory').value);
    
    window.showModal = (title, body, type = 'success') => {
        const modal = { title: document.getElementById('modal-title'), body: document.getElementById('modal-body'), button: document.getElementById('modal-button'), cancelButton: document.getElementById('modal-cancel-button'), container: document.getElementById('modal-container') };
        modal.title.textContent = title;
        modal.body.textContent = body;
        modal.container.classList.remove('hidden');
        const modalButton = document.getElementById('modal-button');
        modalButton.className = 'w-full py-2 rounded-lg font-semibold transition-colors';
        if (type === 'error') {
            modalButton.style.backgroundColor = '#dc2626';
            modalButton.style.color = 'white';
            modalButton.textContent = 'Entendido';
        } else {
            modalButton.style.backgroundColor = 'var(--accent-color-dark)';
            modalButton.style.color = 'var(--text-primary)';
            modalButton.textContent = 'Cerrar';
        }
        modal.cancelButton.classList.add('hidden');
        modal.button.onclick = window.closeModal;
    };
    window.openImageModal = (imageUrl) => { if (!imageUrl) return; document.getElementById('image-modal-content').src = imageUrl; document.getElementById('image-modal-container').classList.remove('hidden'); };
    window.openEditModal = (id, location = 'local1') => {
        const productSource = location === 'local2' ? inventory2 : inventory;
        const product = productSource.find(p => p.id === id); if (!product) return;
        document.getElementById('edit-product-image-preview').src = product.image_url || `https://via.placeholder.com/150/1f2937/ffffff?text=${product.name.substring(0,3).toUpperCase()}`;
        document.getElementById('edit-product-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-price').value = parseFloat(product.price).toFixed(2);
        document.getElementById('edit-product-category').value = product.category || 'Otro';
        document.getElementById('edit-product-quantity').value = product.quantity;
        document.getElementById('edit-product-location').value = location;
        document.getElementById('edit-product-image-file').value = '';
        document.getElementById('edit-modal-container').classList.remove('hidden');
    };
    window.openAddProductModal = (location = 'local1') => {
        document.getElementById('add-product-location').value = location;
        document.getElementById('add-product-modal-container').classList.remove('hidden');
    };
    window.changeView = (viewId) => {
        document.querySelectorAll('.view-content').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
        document.getElementById(`view-${viewId}`).classList.remove('hidden');
        document.getElementById(`nav-${viewId}`).classList.add('active-nav');
        if (viewId === 'sales') populateSaleCategoryDropdown('local1');
        if (viewId === 'local2') changeSubView('local2-inventory');
    };
    window.changeSubView = (subViewId) => {
        document.querySelectorAll('#view-local2 .subview-content').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('#view-local2 nav button').forEach(b => b.classList.remove('active-nav'));
        document.getElementById(`subview-${subViewId}`).classList.remove('hidden');
        document.getElementById(`nav-${subViewId}`).classList.add('active-nav');
        if (subViewId === 'local2-sales') populateSaleCategoryDropdown('local2');
    };
    window.updateInventoryQuantity = async (button, id, delta, location = 'local1') => {
        const inventorySource = location === 'local2' ? inventory2 : inventory;
        const table = location === 'local2' ? 'inventory2' : 'inventory';
        const product = inventorySource.find(p => p.id === id); if (!product) return;
        const newQty = product.quantity + Number(delta); if (newQty < 0) return;
        const productCard = button.closest('[data-product-id]');
        const quantityElement = productCard.querySelector('.product-quantity');
        quantityElement.textContent = `Stock: ${newQty}`;
        product.quantity = newQty; 
        try { const { error } = await supabase.from(table).update({ quantity: newQty }).eq('id', id); if (error) throw error; } 
        catch (e) { product.quantity -= Number(delta); quantityElement.textContent = `Stock: ${product.quantity}`; window.showModal("Error de Sincronizaci칩n", e.message, "error"); }
    };
    window.deleteProduct = (id, name, location = 'local1') => {
        const table = location === 'local2' ? 'inventory2' : 'inventory';
        const loadFunction = location === 'local2' ? loadInventory2 : loadInventory;
        showModal("Confirmar Eliminaci칩n", `쮼liminar '${name}'? Esta acci칩n no se puede deshacer.`, "error");
        const confirmButton = document.getElementById('modal-button');
        const cancelButton = document.getElementById('modal-cancel-button');
        confirmButton.textContent = 'S칤, Eliminar';
        confirmButton.onclick = async () => {
            try { const { error } = await supabase.from(table).delete().eq('id', id); if (error) throw error; showModal("Eliminado", `'${name}' fue eliminado.`, "success"); } 
            catch(e) { showModal("Error", `No se pudo eliminar. ${e.message}`, "error"); } 
            finally { await loadFunction(); renderHeaderSummary(); }
        };
        cancelButton.classList.remove('hidden');
    };
    window.deleteSale = (id, name, location = 'local1') => {
        const table = location === 'local2' ? 'sales2' : 'sales';
        const loadFunction = location === 'local2' ? loadSalesHistory2 : loadSalesHistory;
        showModal("Confirmar Eliminaci칩n", `쮼liminar la venta de '${name}'?`, "error");
        const confirmButton = document.getElementById('modal-button');
        const cancelButton = document.getElementById('modal-cancel-button');
        confirmButton.textContent = 'S칤, Eliminar';
        confirmButton.onclick = async () => {
            try { const { error } = await supabase.from(table).delete().eq('id', id); if (error) throw error; showModal("Venta Eliminada", "La venta fue eliminada.", "success"); } 
            catch(e) { showModal("Error", e.message, "error"); } 
            finally { await loadFunction(); renderHeaderSummary(); }
        };
        cancelButton.classList.remove('hidden');
    };
    window.deleteExpense = (id, description) => {
        showModal("Confirmar Eliminaci칩n", `쮼liminar el gasto '${description}'?`, "error");
        const confirmButton = document.getElementById('modal-button');
        const cancelButton = document.getElementById('modal-cancel-button');
        confirmButton.textContent = 'S칤, Eliminar';
        confirmButton.onclick = async () => {
            try { const { error } = await supabase.from('gastos').delete().eq('id', id); if (error) throw error; showModal("Gasto Eliminado", "El gasto fue eliminado.", "success"); } 
            catch(e) { showModal("Error", e.message, "error"); } 
            finally { await loadExpenses(); renderHeaderSummary(); }
        };
        cancelButton.classList.remove('hidden');
    };

    const uploadToR2 = async (file) => {
        if (!file) return null;
        try {
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch(`${supabaseUrl}/functions/v1/upload-to-r2`, { method: 'POST', headers: { 'Authorization': `Bearer ${supabaseAnonKey}` }, body: formData });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || 'Error al subir archivo a R2'); }
            const data = await response.json();
            return data.url;
        } catch (error) { console.error('Error subiendo archivo a R2:', error); throw error; }
    };
    const renderSkeletonLoader = (container) => {
        let skeletonHTML = '<div><div class="skeleton-line h-8 w-1/4 mb-4"></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
        for(let i = 0; i < 8; i++) {
            skeletonHTML += `<div class="skeleton-card"><div class="skeleton-line h-40 mb-3"></div><div class="skeleton-line h-6 w-3/4 mb-2"></div><div class="skeleton-line h-8 w-1/2"></div></div>`;
        }
        skeletonHTML += '</div></div>';
        container.innerHTML = skeletonHTML;
    };
    const renderInventoryList = (inventorySource, containerId, location, searchTerm = '') => {
        const listContainer = document.getElementById(containerId);
        listContainer.innerHTML = '';
        const filteredInventory = searchTerm ? inventorySource.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())) : inventorySource;
        if (filteredInventory.length === 0) { listContainer.innerHTML = `<p class="text-gray-400 text-center col-span-full">No hay productos que coincidan con la b칰squeda.</p>`; return; }
        const grouped = filteredInventory.reduce((acc, p) => { const cat = p.category || 'Sin Categor칤a'; if (!acc[cat]) acc[cat] = []; acc[cat].push(p); return acc; }, {}); 
        Object.keys(grouped).sort().forEach(category => {
            const section = document.createElement("div");
            section.className = "mb-10";
            section.innerHTML = `<h2 class="text-2xl font-bold text-gray-200 border-b-2 border-indigo-500 pb-2 mb-4 uppercase tracking-wider">${category}</h2>`;
            const grid = document.createElement("div");
            grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
            grouped[category].forEach(p => {
                const card = document.createElement("div");
                card.className = "bg-gray-800 rounded-lg shadow-xl p-4 flex flex-col product-card themed-border relative";
                card.setAttribute('data-product-id', p.id);
                const escapedName = p.name.replace(/'/g, "\\'");
                card.innerHTML = `
                    <button onclick="openEditModal('${p.id}', '${location}')" class="absolute top-2 right-2 text-gray-400 hover:text-indigo-400 transition p-1 rounded-full bg-gray-700/70 shadow-sm" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                    <div class="h-40 bg-gray-600 rounded flex items-center justify-center mb-3 overflow-hidden cursor-pointer" onclick="openImageModal('${p.image_url || ''}')"><img src="${p.image_url || `https://via.placeholder.com/150/1f2937/ffffff?text=${p.name.substring(0,3).toUpperCase()}`}" class="object-contain h-full w-full" loading="lazy"></div>
                    <h3 class="font-semibold text-white">${p.name}</h3>
                    <p class="text-green-400 font-bold text-lg mt-2">$${Number(p.price).toFixed(2)}</p>
                    <p class="mt-1 text-sm text-gray-400 product-quantity">Stock: ${p.quantity}</p>
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-700">
                        <div class="flex gap-2"><button onclick="updateInventoryQuantity(this, '${p.id}', -1, '${location}')" class="px-3 py-1 border rounded bg-gray-700 hover:bg-gray-600 border-gray-600 transition text-white" ${p.quantity <= 0 ? 'disabled' : ''}>-</button><button onclick="updateInventoryQuantity(this, '${p.id}', 1, '${location}')" class="px-3 py-1 border rounded bg-gray-700 hover:bg-gray-600 border-gray-600 transition text-white">+</button></div>
                        <button onclick="deleteProduct('${p.id}', '${escapedName}', '${location}')" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white shadow-md text-sm transition">Eliminar</button>
                    </div>`;
                grid.appendChild(card);
            });
            section.appendChild(grid);
            listContainer.appendChild(section);
        });
    };
    const renderSalesHistory = (historySource, tbodyId, location) => { const tbody = document.getElementById(tbodyId); tbody.innerHTML = ''; historySource.forEach(sale => { const date = new Date(sale.timestamp).toLocaleDateString(); const currentStatus = sale.status || 'Pagado'; const statusClass = { 'Pagado': 'status-paid', 'Pendiente': 'status-pending', 'Devuelto': 'status-returned' }[currentStatus] || 'status-pending'; const row = tbody.insertRow(); row.className = 'hover:bg-gray-900/50 transition-colors'; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${sale.product_name} (x${sale.quantity || 1})</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${sale.recipient}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-green-400 font-bold">$${parseFloat(sale.price).toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${date}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><select onchange="handleStatusChange(this, '${sale.id}', '${location}')" class="status-select text-sm rounded-lg p-2 font-semibold transition-colors cursor-pointer ${statusClass}"><option value="Pagado" ${currentStatus === 'Pagado' ? 'selected' : ''}>Pagado</option><option value="Pendiente" ${currentStatus === 'Pendiente' ? 'selected' : ''}>Pendiente</option><option value="Devuelto" ${currentStatus === 'Devuelto' ? 'selected' : ''}>Devuelto</option></select></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="deleteSale('${sale.id}', '${sale.product_name.replace(/'/g, "\\'")}', '${location}')" class="text-red-500 hover:text-red-300">Eliminar</button></td>`; }); if (historySource.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No hay ventas.</td></tr>`; } };
    const renderExpenses = () => { const tbody = document.getElementById('expenses-history-body'); tbody.innerHTML = ''; expensesHistory.forEach(expense => { const date = new Date(expense.timestamp).toLocaleDateString(); const row = tbody.insertRow(); row.className = 'hover:bg-gray-900/50 transition-colors'; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${expense.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-400 font-bold">$${parseFloat(expense.amount).toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${date}</td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button onclick="deleteExpense('${expense.id}', '${expense.description.replace(/'/g, "\\'")}' )" class="text-red-500 hover:text-red-300">Eliminar</button></td>`; }); if (expensesHistory.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No hay gastos.</td></tr>`; } };
    const populateSaleCategoryDropdown = (location) => { const inventorySource = location === 'local2' ? inventory2 : inventory; const categorySelect = document.getElementById(location === 'local2' ? 'sale-category-2' : 'sale-category'); const productSelect = document.getElementById(location === 'local2' ? 'sale-product-id-2' : 'sale-product-id'); productSelect.innerHTML = '<option value="" disabled selected>Selecciona</option>'; productSelect.disabled = true; const categories = [...new Set(inventorySource.map(p => p.category || 'Sin Categor칤a'))].sort(); categorySelect.innerHTML = '<option value="" disabled selected>Selecciona</option>'; categories.forEach(c => { const option = document.createElement('option'); option.value = c; option.textContent = c; categorySelect.appendChild(option); }); };
    const populateSaleProductDropdown = (category, location) => { const inventorySource = location === 'local2' ? inventory2 : inventory; const productSelect = document.getElementById(location === 'local2' ? 'sale-product-id-2' : 'sale-product-id'); const priceInput = document.getElementById(location === 'local2' ? 'sale-price-2' : 'sale-price'); if(priceInput) priceInput.value = '0.00'; if (!category) { productSelect.disabled = true; return; } const products = inventorySource.filter(p => (p.category || 'Sin Categor칤a') === category && p.quantity > 0); productSelect.innerHTML = '<option value="" disabled selected>Selecciona</option>'; products.forEach(p => { const option = document.createElement('option'); option.value = p.id; option.textContent = `${p.name} (${p.quantity} disp.)`; productSelect.appendChild(option); }); productSelect.disabled = products.length === 0; };
    const renderHeaderSummary = () => { const today = new Date().toLocaleDateString(); const allSales = [...salesHistory, ...salesHistory2]; const todaySales = allSales.filter(s => new Date(s.timestamp).toLocaleDateString() === today); const todayExpenses = expensesHistory.filter(e => new Date(e.timestamp).toLocaleDateString() === today); const todaySoldTotal = todaySales.reduce((sum, s) => sum + parseFloat(s.price || 0), 0); const todayPaidTotal = todaySales.filter(s => (s.status || 'Pagado') === 'Pagado').reduce((sum, s) => sum + parseFloat(s.price || 0), 0); const todayExpensesTotal = todayExpenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0); document.getElementById('today-sold-total').textContent = `$${todaySoldTotal.toFixed(2)}`; document.getElementById('today-paid-total').textContent = `$${todayPaidTotal.toFixed(2)}`; document.getElementById('today-expenses-total').textContent = `$${todayExpensesTotal.toFixed(2)}`; };

    async function loadAllData() { try { await Promise.all([ loadInventory(), loadInventory2(), loadSalesHistory(), loadSalesHistory2(), loadExpenses(), loadSettings() ]); renderHeaderSummary(); } catch (e) { document.getElementById('error-message').textContent = `Error al cargar datos: ${e.message}`; document.getElementById('error-message').classList.remove('hidden'); } }
    async function loadInventory() { const { data, error } = await supabase.from('inventory').select('*').eq('user_id', currentUserId).order('created_at', { ascending: false }); if (error) throw error; inventory = data || []; renderInventoryList(inventory, 'inventory-list', 'local1', document.getElementById('search-inventory').value.toLowerCase()); }
    async function loadInventory2() { const { data, error } = await supabase.from('inventory2').select('*').eq('user_id', currentUserId).order('created_at', { ascending: false }); if (error) throw error; inventory2 = data || []; renderInventoryList(inventory2, 'inventory-list-2', 'local2'); }
    async function loadSalesHistory() { const { data, error } = await supabase.from('sales').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false }); if (error) throw error; salesHistory = data || []; renderSalesHistory(salesHistory, 'sales-history-body', 'local1'); }
    async function loadSalesHistory2() { const { data, error } = await supabase.from('sales2').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false }); if (error) throw error; salesHistory2 = data || []; renderSalesHistory(salesHistory2, 'sales-history-body-2', 'local2'); }
    async function loadExpenses() { const { data, error } = await supabase.from('gastos').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false }); if (error) throw error; expensesHistory = data || []; renderExpenses(); }
    async function loadSettings() { const { data, error } = await supabase.from('settings').select('store_logo_url').eq('user_id', currentUserId).single(); if (data?.store_logo_url) document.getElementById('store-logo-img').src = data.store_logo_url; }
    
    async function handleAddProduct(event) { event.preventDefault(); const form = event.currentTarget; const location = form.querySelector('#add-product-location').value; const table = location === 'local2' ? 'inventory2' : 'inventory'; const loadFn = location === 'local2' ? loadInventory2 : loadInventory; const inventorySource = location === 'local2' ? inventory2 : inventory; const data = { name: form.querySelector('#product-name-modal').value, category: form.querySelector('#product-category-modal').value, quantity: parseInt(form.querySelector('#product-quantity-modal').value), price: parseFloat(form.querySelector('#product-price-initial-modal').value), file: form.querySelector('#product-image-file-modal').files[0] }; if (!data.name || !data.category) return window.showModal("Error", "Faltan datos", "error"); try { const imageUrl = data.file ? await uploadToR2(data.file) : null; const existing = inventorySource.find(p => p.name.toLowerCase() === data.name.toLowerCase()); if (existing) { await supabase.from(table).update({ quantity: existing.quantity + data.quantity }).eq('id', existing.id); } else { await supabase.from(table).insert([{ user_id: currentUserId, name: data.name, category: data.category, quantity: data.quantity, price: data.price, image_url: imageUrl }]); } window.closeAddProductModal(); } catch (e) { window.showModal("Error", e.message, "error"); } finally { await loadFn(); } }
    async function handleEditProduct(event) { event.preventDefault(); const form = event.currentTarget; const id = form.querySelector('#edit-product-id').value; const location = form.querySelector('#edit-product-location').value; const table = location === 'local2' ? 'inventory2' : 'inventory'; const loadFn = location === 'local2' ? loadInventory2 : loadInventory; const file = form.querySelector('#edit-product-image-file').files[0]; const updateData = { name: form.querySelector('#edit-product-name').value, category: form.querySelector('#edit-product-category').value, price: parseFloat(form.querySelector('#edit-product-price').value), quantity: parseInt(form.querySelector('#edit-product-quantity').value) }; try { if (file) { updateData.image_url = await uploadToR2(file); } await supabase.from(table).update(updateData).eq('id', id); window.closeEditModal(); } catch (e) { window.showModal("Error", e.message, "error"); } finally { await loadFn(); } }
    async function handleRecordSale(event, location) { event.preventDefault(); const form = event.currentTarget; const formSuffix = location === 'local2' ? '-2' : ''; const productId = form.querySelector(`#sale-product-id${formSuffix}`).value; if(!productId) return showModal("Error", "Debes seleccionar un producto.", "error"); const saleQuantity = parseInt(form.querySelector(`#sale-quantity${formSuffix}`).value, 10); const recipient = form.querySelector(`#sale-recipient${formSuffix}`).value.trim(); const price = parseFloat(form.querySelector(`#sale-price${formSuffix}`).value); const status = form.querySelector(`#sale-status${formSuffix}`).value; const inventorySource = location === 'local2' ? inventory2 : inventory; const salesTable = location === 'local2' ? 'sales2' : 'sales'; const inventoryTable = location === 'local2' ? 'inventory2' : 'inventory'; const loadFn = location === 'local2' ? loadInventory2 : loadInventory; const loadSalesFn = location === 'local2' ? loadSalesHistory2 : loadSalesHistory; if (!recipient || !price || saleQuantity <= 0) return showModal("Datos Incompletos", "Faltan datos obligatorios.", "error"); const product = inventorySource.find(p => p.id === productId); if (!product || product.quantity < saleQuantity) return showModal("Error", "No hay stock suficiente.", "error"); try { await supabase.from(salesTable).insert([{ user_id: currentUserId, product_name: product.name, product_id: productId, recipient, price, status, quantity: saleQuantity, timestamp: new Date() }]); await supabase.from(inventoryTable).update({ quantity: product.quantity - saleQuantity }).eq('id', product.id); form.reset(); } catch (e) { showModal("Error de Venta", e.message, "error"); } finally { await loadFn(); await loadSalesFn(); renderHeaderSummary(); } }
    async function handleRecordExpense(event) { event.preventDefault(); const form = event.currentTarget; const description = form.querySelector('#expense-description').value.trim(); const amount = parseFloat(form.querySelector('#expense-amount').value); if (!description || !amount) return showModal("Datos Incompletos", "Faltan datos.", "error"); try { await supabase.from('gastos').insert([{ user_id: currentUserId, description, amount, timestamp: new Date() }]); form.reset(); } catch(e) { showModal("Error", e.message, "error"); } finally { await loadExpenses(); renderHeaderSummary(); } }
    async function updateSaleStatus(saleId, newStatus, location) { const salesTable = location === 'local2' ? 'sales2' : 'sales'; const inventoryTable = location === 'local2' ? 'inventory2' : 'inventory'; const historySource = location === 'local2' ? salesHistory2 : salesHistory; const inventorySource = location === 'local2' ? inventory2 : inventory; const loadSalesFn = location === 'local2' ? loadSalesHistory2 : loadSalesHistory; const loadInvFn = location === 'local2' ? loadInventory2 : loadInventory; const sale = historySource.find(s => s.id === saleId); if (!sale) return; const oldStatus = sale.status || 'Pagado'; if (oldStatus === newStatus) return; try { if (sale.product_id) { const product = inventorySource.find(p => p.id === sale.product_id); const qty = sale.quantity || 1; let stockChange = 0; if (newStatus === 'Devuelto' && oldStatus !== 'Devuelto') stockChange = qty; else if (oldStatus === 'Devuelto' && newStatus !== 'Devuelto') stockChange = -qty; if (stockChange !== 0 && product) { await supabase.from(inventoryTable).update({ quantity: product.quantity + stockChange }).eq('id', product.id); } } await supabase.from(salesTable).update({ status: newStatus }).eq('id', saleId); } catch(e) { showModal("Error", e.message, "error"); } finally { await loadSalesFn(); await loadInvFn(); renderHeaderSummary(); } }
    async function handleLogoFileSelect(event) { const file = event.target.files[0]; if (!file) return; try { const logoUrl = await uploadToR2(file); await supabase.from('settings').upsert({ user_id: currentUserId, store_logo_url: logoUrl }, { onConflict: 'user_id' }); document.getElementById('store-logo-img').src = logoUrl; } catch (e) { showModal("Error", e.message, "error"); } }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('selectedTheme') || 'theme-dark';
        document.getElementById('theme-selector').value = savedTheme;
        
        window.changeView('inventory');
        renderSkeletonLoader(document.getElementById('inventory-list'));
        renderSkeletonLoader(document.getElementById('inventory-list-2'));

        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            currentUserId = PUBLIC_STORE_ID;
            loadAllData();
        } catch (error) {
            document.getElementById('error-message').textContent = `Error de Conexi칩n: ${error.message}`;
            document.getElementById('error-message').classList.remove('hidden');
        }

        document.getElementById('add-product-form-modal').addEventListener('submit', handleAddProduct);
        document.getElementById('edit-product-form').addEventListener('submit', handleEditProduct);
        document.getElementById('record-sale-form').addEventListener('submit', (e) => handleRecordSale(e, 'local1'));
        document.getElementById('record-sale-form-2').addEventListener('submit', (e) => handleRecordSale(e, 'local2'));
        document.getElementById('record-expense-form').addEventListener('submit', handleRecordExpense);
        document.getElementById('store-logo-img').addEventListener('click', () => document.getElementById('logo-file-input').click());
        document.getElementById('logo-file-input').addEventListener('change', handleLogoFileSelect);
        document.getElementById('theme-selector').addEventListener('change', (e) => window.changeTheme(e.target.value));
        document.getElementById('search-inventory').addEventListener('input', () => window.filterInventory());
        document.getElementById('sale-category').addEventListener('change', (e) => populateSaleProductDropdown(e.target.value, 'local1'));
        document.getElementById('sale-product-id').addEventListener('change', (e) => { const product = inventory.find(p => p.id === e.target.value); if (product) document.getElementById('sale-price').value = product.price.toFixed(2); });
        document.getElementById('sale-category-2').addEventListener('change', (e) => populateSaleProductDropdown(e.target.value, 'local2'));
        document.getElementById('sale-product-id-2').addEventListener('change', (e) => { const product = inventory2.find(p => p.id === e.target.value); if (product) { const priceInput = document.getElementById('sale-price-2'); if(priceInput) priceInput.value = product.price.toFixed(2);} });
    });
</script>
</body>
</html>
