<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRPHONE PRODUCTOS Y VENTAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #d1d5db;
            --text-accent: #d97706;
            --text-accent-hover: #fbbf24;
            --border-color: #4b5563;
            --button-primary-bg: #d97706;
            --button-primary-text: #111827;
            --button-primary-hover: #b45309;
            --header-shadow: rgba(124, 45, 18, 0.2);
        }

        .theme-fuego-infernal {
            --bg-body: #1e1b18;
            --bg-card: #2d2a26;
            --text-main: #e0e0e0;
            --text-accent: #ef4444;
            --text-accent-hover: #f87171;
            --border-color: #5c5c5c;
            --button-primary-bg: #b91c1c;
            --button-primary-text: #ffffff;
            --button-primary-hover: #991b1b;
            --header-shadow: rgba(185, 28, 28, 0.3);
        }

        .theme-hacker-matrix {
            --bg-body: #000000;
            --bg-card: #0d1a0d;
            --text-main: #00ff00;
            --text-accent: #39ff14;
            --text-accent-hover: #adff2f;
            --border-color: #008f11;
            --button-primary-bg: #00ff00;
            --button-primary-text: #000000;
            --button-primary-hover: #00e600;
            --header-shadow: rgba(0, 255, 0, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
        }
        input, select {
            background-color: var(--bg-body);
            border-color: var(--border-color);
        }
        input:focus, select:focus {
            --tw-ring-color: var(--text-accent);
            border-color: var(--text-accent);
        }
        .luxury-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        .header-shadow {
             box-shadow: 0 10px 15px -3px var(--header-shadow), 0 4px 6px -2px var(--header-shadow);
        }
        .quantity-btn {
            @apply bg-amber-700 text-white hover:bg-amber-600 transition-colors shadow-lg shadow-amber-900/50
                   rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold p-0.5;
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }
        .quantity-btn:hover {
            background-color: var(--button-primary-hover);
        }
        #store-logo-img {
            cursor: pointer;
            object-fit: contain; 
        }
        #store-logo-container {
            width: 240px; 
            height: 80px;  
            display: flex; 
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            flex-shrink: 0; 
        }
        select.status-select option {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <input type="file" id="logo-file-input" class="hidden" accept="image/*">

    <div id="app" class="flex-grow p-4 md:p-8">
        <header class="mb-6 md:mb-10 luxury-card header-shadow p-4 rounded-xl">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                <div class="flex items-center mb-4 sm:mb-0">
                    <div id="store-logo-container" title="Haz clic para cambiar el logo">
                        <img id="store-logo-img" src="https://placehold.co/240x80/1f2937/d97706?text=MRPHONE" alt="Store Logo"
                             class="w-full h-full transition-transform hover:scale-105">
                    </div>
                    <h1 class="text-2xl md:text-3xl font-extrabold" style="color: var(--text-accent);">
                        MRPHONE PRODUCTOS Y VENTAS
                    </h1>
                </div>
                <div class="flex flex-col items-start sm:items-end space-y-2 w-full sm:w-auto">
                    <div id="daily-sales-summary" class="flex flex-col space-y-1 text-sm md:text-base font-semibold luxury-card p-2 rounded-lg w-full" style="border-color: var(--text-accent-hover);">
                        <p>Vendido HOY: <span id="today-sold-total" class="font-bold" style="color: var(--text-accent);">$0.00</span></p>
                        <p>Pagado HOY: <span id="today-paid-total" class="text-green-400 font-bold">$0.00</span></p>
                        <p>Gastos HOY: <span id="today-expenses-total" class="text-red-400 font-bold">$0.00</span></p>
                    </div>
                    <div class="flex space-x-2 w-full">
                         <select id="theme-selector" onchange="changeTheme(this.value)" class="w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-2 border">
                            <option value="luxury-gold">Luxury Gold</option>
                            <option value="fuego-infernal">Fuego Infernal</option>
                            <option value="hacker-matrix">Hacker Matrix</option>
                        </select>
                        <button onclick="openAddProductModal()" class="w-full sm:w-auto px-4 py-2 rounded-lg font-bold transition-colors shadow-lg whitespace-nowrap" style="background-color: var(--button-primary-bg); color: var(--button-primary-text);">
                            Añadir Producto
                        </button>
                    </div>
                </div>
            </div>
            <nav class="flex justify-around space-x-2 border-b" style="border-color: var(--border-color);">
                <button onclick="changeView('inventory')" id="nav-inventory"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none" style="--tw-hover-border-color: var(--text-accent-hover); --tw-hover-text-color: var(--text-accent-hover);">
                    Inventario
                </button>
                <button onclick="changeView('sales')" id="nav-sales"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none" style="--tw-hover-border-color: var(--text-accent-hover); --tw-hover-text-color: var(--text-accent-hover);">
                    Registrar Venta
                </button>
                <button onclick="changeView('expenses')" id="nav-expenses"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none" style="--tw-hover-border-color: var(--text-accent-hover); --tw-hover-text-color: var(--text-accent-hover);">
                    Gastos
                </button>
                <button onclick="changeView('history')" id="nav-history"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none" style="--tw-hover-border-color: var(--text-accent-hover); --tw-hover-text-color: var(--text-accent-hover);">
                    Historial de Ventas
                </button>
            </nav>
        </header>

        <main>
            <div id="loading-spinner" class="text-center p-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4" style="border-color: var(--text-accent);"></div>
                <p class="mt-4" style="color: var(--text-accent);">Conectando a Supabase y sincronizando datos...</p>
            </div>
            <div id="error-message" class="text-center p-4 bg-red-900/50 text-red-300 rounded-lg shadow-md hidden"></div>

            <section id="view-inventory" class="view-content hidden">
                <div class="p-6 luxury-card rounded-xl shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6">
                        <h2 class="text-2xl font-bold mb-4 md:mb-0" style="color: var(--text-accent);">Inventario Actual</h2>
                        <div class="relative w-full md:w-72">
                            <input type="text" id="search-inventory" oninput="filterInventory()" placeholder="Buscar producto..."
                                   class="w-full rounded-lg text-white shadow-sm p-3 pl-10 border">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                    <div id="inventory-list" class="space-y-8">
                        <p class="text-gray-500 text-center col-span-full">Cargando inventario...</p>
                    </div>
                </div>
            </section>

            <section id="view-sales" class="view-content hidden">
                <div class="max-w-xl mx-auto p-6 luxury-card rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-accent);">Registrar Venta</h2>
                    <form id="record-sale-form" class="space-y-4">
                        <div>
                            <label for="sale-category" class="block text-sm font-medium">Categoría</label>
                            <select id="sale-category" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                                <option value="" disabled selected>Primero selecciona una categoría</option>
                            </select>
                        </div>
                        <div>
                            <label for="sale-product-id" class="block text-sm font-medium">Producto</label>
                            <select id="sale-product-id" required disabled class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border disabled:opacity-50 disabled:cursor-not-allowed">
                                <option value="" disabled selected>Selecciona un producto</option>
                            </select>
                        </div>
                        <div>
                            <label for="sale-quantity" class="block text-sm font-medium">Cantidad Vendida</label>
                            <input type="number" id="sale-quantity" required min="1" step="1" value="1" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                        </div>
                        <div>
                            <label for="sale-recipient" class="block text-sm font-medium">Destinatario / Cliente</label>
                            <input type="text" id="sale-recipient" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                        </div>
                        <div>
                            <label for="sale-price" class="block text-sm font-medium">Precio de Venta ($)</label>
                            <input type="number" id="sale-price" required min="0.01" step="0.01" value="0.00" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                        </div>
                         <div>
                            <label for="sale-status" class="block text-sm font-medium">Estado de Pago</label>
                            <select id="sale-status" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                                <option value="Pagado">Pagado</option>
                                <option value="Pendiente">Pendiente</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-red-700 text-white p-3 rounded-lg font-bold hover:bg-red-800 transition-colors shadow-lg shadow-red-900/50">
                            Confirmar Venta
                        </button>
                    </form>
                </div>
            </section>

            <section id="view-expenses" class="view-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2">
                        <div class="p-6 luxury-card rounded-xl shadow-xl">
                            <h2 class="text-2xl font-bold mb-6" style="color: var(--text-accent);">Registrar Gasto</h2>
                            <form id="record-expense-form" class="space-y-4">
                                <div>
                                    <label for="expense-description" class="block text-sm font-medium">Descripción del Gasto</label>
                                    <input type="text" id="expense-description" required placeholder="Ej: Alquiler, Salario, Compra de Herramientas"
                                        class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                                </div>
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium">Monto del Gasto ($)</label>
                                    <input type="number" id="expense-amount" required min="0.01" step="0.01" value="0.00"
                                        class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                                </div>
                                <button type="submit" class="w-full text-white p-3 rounded-lg font-bold transition-colors shadow-lg" style="background-color: var(--button-primary-bg); color: var(--button-primary-text);">
                                    Confirmar Gasto
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                        <div class="p-6 luxury-card rounded-xl shadow-xl">
                            <h2 class="text-2xl font-bold mb-6" style="color: var(--text-accent);">Historial de Gastos</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                    <thead>
                                        <tr style="background-color: var(--bg-body);">
                                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Descripción</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Monto</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Fecha</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenses-history-body" class="divide-y" style="background-color: var(--bg-card); border-color: var(--border-color);"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="view-history" class="view-content hidden">
                <div class="p-6 luxury-card rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-accent);">Historial de Ventas</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                            <thead>
                                <tr style="background-color: var(--bg-body);">
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Destinatario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Precio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Estado</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-accent);">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-body" class="divide-y" style="background-color: var(--bg-card); border-color: var(--border-color);"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all border-l-4">
            <h3 id="modal-title" class="text-xl font-bold mb-3"></h3>
            <p id="modal-body" class="mb-4"></p>
            <div class="flex flex-col space-y-2 pt-4">
                <button id="modal-button" class="w-full py-2 rounded-lg font-semibold transition-colors"></button>
                <button id="modal-cancel-button" onclick="closeModal()" class="w-full py-2 rounded-lg font-semibold border border-gray-500 text-gray-300 hover:bg-gray-700 transition-colors hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="edit-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all border-l-4" style="border-color: var(--text-accent);">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-accent);">Editar Producto</h3>
            <form id="edit-product-form" class="space-y-4">
                <input type="hidden" id="edit-product-id">
                <div>
                    <label for="edit-product-name" class="block text-sm font-medium">Nombre</label>
                    <input type="text" id="edit-product-name" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                </div>
                <div>
                    <label for="edit-product-category" class="block text-sm font-medium">Categoría</label>
                    <select id="edit-product-category" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                        <option value="Flex Main">Flex Main</option>
                        <option value="Pantallas">Pantallas</option>
                        <option value="Jacks De Carga">Jacks De Carga</option>
                        <option value="Plaquitas de Carga">Plaquitas de Carga</option>
                        <option value="Protectores Fisicos">Protectores Fisicos</option>
                        <option value="Vidrio Templado">Vidrio Templado</option>
                        <option value="Glass Privado">Glass Privado</option>
                        <option value="Glass Ceramico Privado">Glass Ceramico Privado</option>
                        <option value="Glass Curvo">Glass Curvo</option>
                        <option value="Audifonos">Audifonos</option>
                        <option value="Lentes de Camara">Lentes de Camara</option>
                        <option value="Cargadores">Cargadores</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-product-price" class="block text-sm font-medium">Precio ($)</label>
                    <input type="number" id="edit-product-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2 rounded-lg font-semibold border transition-colors" style="color: var(--text-accent); border-color: var(--text-accent);">Cancelar</button>
                    <button type="submit" class="flex-1 p-3 rounded-lg font-bold shadow-lg" style="background-color: var(--button-primary-bg); color: var(--button-primary-text);">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-product-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all border-l-4" style="border-color: var(--text-accent);">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-accent);">Añadir Nuevo Producto</h3>
            <form id="add-product-form" class="space-y-4">
                <div>
                    <label for="product-name" class="block text-sm font-medium">Nombre del Producto</label>
                    <input type="text" id="product-name" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                </div>
                <div>
                    <label for="product-category" class="block text-sm font-medium">Categoría</label>
                    <select id="product-category" required class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                        <option value="" disabled selected>Selecciona una categoría</option>
                        <option value="Flex Main">Flex Main</option>
                        <option value="Pantallas">Pantallas</option>
                        <option value="Jacks De Carga">Jacks De Carga</option>
                        <option value="Plaquitas de Carga">Plaquitas de Carga</option>
                        <option value="Protectores Fisicos">Protectores Fisicos</option>
                        <option value="Vidrio Templado">Vidrio Templado</option>
                        <option value="Glass Privado">Glass Privado</option>
                        <option value="Glass Ceramico Privado">Glass Ceramico Privado</option>
                        <option value="Glass Curvo">Glass Curvo</option>
                        <option value="Audifonos">Audifonos</option>
                        <option value="Lentes de Camara">Lentes de Camara</option>
                        <option value="Cargadores">Cargadores</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label for="product-price-initial" class="block text-sm font-medium">Precio Inicial ($)</label>
                    <input type="number" id="product-price-initial" required min="0.01" step="0.01" value="100.00" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                </div>
                <div>
                    <label for="product-quantity" class="block text-sm font-medium">Cantidad Inicial</label>
                    <input type="number" id="product-quantity" required min="1" value="1" class="mt-1 block w-full rounded-lg text-white shadow-sm p-3 border">
                </div>
                <div>
                    <label for="product-image-file" class="block text-sm font-medium">Subir Foto (Opcional, máx 500KB)</label>
                    <input type="file" id="product-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold" style="color: var(--text-main);">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeAddProductModal()" class="flex-1 py-2 rounded-lg font-semibold border transition-colors" style="color: var(--text-accent); border-color: var(--text-accent);">Cancelar</button>
                    <button type="submit" id="add-product-submit-button" class="flex-1 p-3 rounded-lg font-bold shadow-lg" style="background-color: var(--button-primary-bg); color: var(--button-primary-text);">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="image-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden" onclick="closeImageModal()">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 transition-colors">&times;</button>
        <img id="image-modal-content" src="" alt="Producto Ampliado" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    </div>

    <script type="module">
        // --- CONFIGURACIÓN DE SUPABASE ---
        const supabaseUrl = 'https://osqrggvtthczsxoovyps.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zcXJnZ3Z0dGhjenN4b292eXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDQ2OTUsImV4cCI6MjA3NTQ4MDY5NX0.yvCMoyMhuHkuKB_uA1P33rSC7U30MnixgTQNIEEp-dQ';
        
        let supabase = null, 
            inventory = [], 
            salesHistory = [], 
            expensesHistory = [],
            pollingIntervalId = null;

        const PUBLIC_STORE_ID = 'public_store_id_mrphone'; 
        let currentUserId = null; 

        // --- MANEJO DE TEMAS ---
        const themes = {
            'luxury-gold': 'Luxury Gold',
            'fuego-infernal': 'theme-fuego-infernal',
            'hacker-matrix': 'theme-hacker-matrix'
        };

        window.applyTheme = (theme) => {
            document.body.classList.remove(...Object.values(themes));
            if (themes[theme] && theme !== 'luxury-gold') {
                document.body.classList.add(themes[theme]);
            }
        };

        window.changeTheme = (theme) => {
            applyTheme(theme);
            localStorage.setItem('mrphone_theme', theme);
        };

        // --- FUNCIONES DE UTILIDAD (MODALES, VISTAS) ---
        window.showModal = (title, body, type = 'success') => {
            const modal = {
                title: document.getElementById('modal-title'),
                body: document.getElementById('modal-body'),
                button: document.getElementById('modal-button'),
                cancelButton: document.getElementById('modal-cancel-button'),
                content: document.getElementById('modal-content'),
                container: document.getElementById('modal-container')
            };
            modal.title.textContent = title;
            modal.body.textContent = body;
            modal.container.classList.remove('hidden');

            const modalButton = document.getElementById('modal-button');
            modalButton.className = 'w-full py-2 rounded-lg font-semibold transition-colors';
            if (type === 'error') {
                modal.title.style.color = '#f87171'; // Un rojo más visible en temas oscuros
                modalButton.style.backgroundColor = '#b91c1c';
                modalButton.style.color = 'white';
                modalButton.textContent = 'Entendido';
            } else {
                modal.title.style.color = 'var(--text-accent)';
                modalButton.style.backgroundColor = 'var(--button-primary-bg)';
                modalButton.style.color = 'var(--button-primary-text)';
                modalButton.textContent = 'Cerrar';
            }

            modal.cancelButton.classList.add('hidden');
            modal.button.onclick = closeModal;
        };
        window.closeModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-cancel-button').classList.add('hidden');
        }

        window.openImageModal = (imageUrl) => {
            if (!imageUrl) return;
            document.getElementById('image-modal-content').src = imageUrl;
            document.getElementById('image-modal-container').classList.remove('hidden');
        };

        window.closeImageModal = () => {
            document.getElementById('image-modal-container').classList.add('hidden');
            document.getElementById('image-modal-content').src = '';
        };

        window.openEditModal = (id) => {
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = parseFloat(product.price).toFixed(2);
            document.getElementById('edit-product-category').value = product.category || 'Otro';
            document.getElementById('edit-modal-container').classList.remove('hidden');
        };
        window.closeEditModal = () => document.getElementById('edit-modal-container').classList.add('hidden');
        window.openAddProductModal = () => document.getElementById('add-product-modal-container').classList.remove('hidden');
        window.closeAddProductModal = () => {
            document.getElementById('add-product-modal-container').classList.add('hidden');
            document.getElementById('add-product-form').reset();
        }

        window.handleStatusChange = async (selectElement, saleId) => {
            const newStatus = selectElement.value;
            await updateSaleStatus(saleId, newStatus);
        };

        window.changeView = (viewId) => {
            document.querySelectorAll('.view-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => {
                b.style.color = '#9ca3af';
                b.style.borderColor = 'transparent';
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            const activeNavButton = document.getElementById(`nav-${viewId}`);
            activeNavButton.style.color = 'var(--text-accent)';
            activeNavButton.style.borderColor = 'var(--text-accent)';

            if (viewId === 'sales') {
                populateSaleCategoryDropdown();
            }
        };

        const fileToBase64 = (file, maxSize) => new Promise((resolve, reject) => {
            if (!file) return resolve(null);
            if (file.size > maxSize) return reject(`Archivo demasiado grande. Límite: ${(maxSize / 1048576).toFixed(0)} MB.`); 
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject("Error al leer archivo.");
        });

        // --- INICIALIZACIÓN Y GESTIÓN DEL ID DE TIENDA COMPARTIDO ---

        const initializeApp = () => {
            const savedTheme = localStorage.getItem('mrphone_theme') || 'luxury-gold';
            document.getElementById('theme-selector').value = savedTheme;
            applyTheme(savedTheme);

            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                currentUserId = PUBLIC_STORE_ID; 
                localStorage.setItem('mrphone_user_id', currentUserId);
                startPolling(true);
            } catch (error) {
                document.getElementById('error-message').textContent = `Error de Conexión: ${error.message}`;
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        };

        const startPolling = (initialLoad = false) => {
            clearInterval(pollingIntervalId);
            loadAllData(initialLoad);
            pollingIntervalId = setInterval(() => loadAllData(false), 5000); 
        };

        const stopPolling = () => {
            clearInterval(pollingIntervalId);
        };

        async function loadAllData(showSpinner = false) {
            const loadingSpinner = document.getElementById('loading-spinner');
            if (showSpinner) loadingSpinner.classList.remove('hidden');
            
            try {
                await Promise.all([loadInventory(), loadSalesHistory(), loadExpenses(), loadSettings()]); 
                renderHeaderSummary();
            } catch (e) { 
                console.error("Error cargando datos:", e);
                document.getElementById('error-message').textContent = `Error al cargar datos. Mensaje: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden'); 
            }
            finally {
                loadingSpinner.classList.add('hidden');
                if (showSpinner) {
                    changeView('inventory');
                }
            }
        }
        const loadInventory = async () => {
            const { data, error } = await supabase.from('inventory').select('*').eq('user_id', currentUserId).order('created_at', { ascending: false });
            if (error) throw error;
            inventory = (data || []).map(p => ({ ...p, price: p.price ?? 0.01 }));
            
            const searchTerm = document.getElementById('search-inventory').value;
            if (!searchTerm) {
                renderInventoryList();
            } else {
                renderInventoryList(searchTerm.toLowerCase());
            }
        };
        
        const loadSalesHistory = async () => {
            const { data, error } = await supabase.from('sales').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false });
            if (error) throw error;
            salesHistory = data || [];
            renderSalesHistory();
        };

        const loadExpenses = async () => {
            const { data, error } = await supabase.from('gastos').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false });
            if (error) throw error;
            expensesHistory = data || [];
            renderExpenses();
        };

        const loadSettings = async () => {
            const { data, error } = await supabase.from('settings').select('store_logo_url').eq('user_id', currentUserId).single();
            if (error && error.code !== 'PGRST116') { console.error("Error cargando settings:", error); } 
            if (data?.store_logo_url) renderStoreLogo(data.store_logo_url);
        };

        // --- RENDERIZACIÓN ---
        const renderStoreLogo = (url) => {
            const logoImg = document.getElementById('store-logo-img');
            const placeholder = "https://placehold.co/240x80/d97706/1f2937?text=MRPHONE";
            logoImg.src = url || placeholder;
            logoImg.onerror = () => { logoImg.src = placeholder; };
        };
        
        const renderHeaderSummary = () => {
            const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric' });
            
            const todaySales = salesHistory.filter(sale => new Date(sale.timestamp).toLocaleDateString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric' }) === today);
            const todayExpenses = expensesHistory.filter(expense => new Date(expense.timestamp).toLocaleDateString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric' }) === today);

            const todaySoldTotal = todaySales.reduce((sum, sale) => sum + parseFloat(sale.price || 0), 0);
            const todayPaidTotal = todaySales.filter(sale => (sale.status || 'Pagado') === 'Pagado').reduce((sum, sale) => sum + parseFloat(sale.price || 0), 0);
            const todayExpensesTotal = todayExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);

            document.getElementById('today-sold-total').textContent = `$${todaySoldTotal.toFixed(2)}`;
            document.getElementById('today-paid-total').textContent = `$${todayPaidTotal.toFixed(2)}`;
            document.getElementById('today-expenses-total').textContent = `$${todayExpensesTotal.toFixed(2)}`;
        };

        window.filterInventory = () => {
            const searchTerm = document.getElementById('search-inventory').value;
            if (searchTerm.trim() !== '') {
                stopPolling();
            } else {
                startPolling(false);
            }
            renderInventoryList(searchTerm.toLowerCase());
        }
        
        const renderInventoryList = (searchTerm = '') => {
            const listContainer = document.getElementById('inventory-list');
            listContainer.innerHTML = '';
            listContainer.className = 'space-y-8';

            const searchWords = searchTerm.toLowerCase().split(' ').filter(word => word.length > 0);

            const filteredInventory = searchTerm.trim() === '' ? inventory : inventory.filter(p => {
                const searchableText = `${p.name.toLowerCase()} ${p.category ? p.category.toLowerCase() : ''}`;
                return searchWords.every(word => searchableText.includes(word));
            });

            if (filteredInventory.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 text-center col-span-full">No se encontraron productos ${searchTerm ? `que coincidan con "${searchTerm}"` : ''}.</p>`;
                return;
            }

            const groupedInventory = filteredInventory.reduce((acc, product) => {
                const category = product.category || 'Sin Categoría';
                if (!acc[category]) acc[category] = [];
                acc[category].push(product);
                return acc;
            }, {});

            const sortedCategories = Object.keys(groupedInventory).sort();

            sortedCategories.forEach(category => {
                const header = document.createElement('h2');
                header.className = 'text-xl font-semibold pt-6 pb-2 border-b-2';
                header.style.color = 'var(--text-accent)';
                header.style.borderColor = 'var(--border-color)';
                header.textContent = category;
                
                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

                groupedInventory[category].forEach(p => {
                    const initials = p.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                    const placeholder = `https://placehold.co/150x150/d97706/1f2937?text=${initials}&font=inter`;
                    const item = document.createElement('div');
                    item.className = 'flex flex-col items-center p-4 luxury-card rounded-xl shadow-lg hover:shadow-amber-900/40 transition-shadow duration-300 transform hover:scale-[1.01]';
                    
                    item.innerHTML = `
                        <img src="${p.image_url || placeholder}" onerror="this.src='${placeholder}'" alt="${p.name}" 
                             class="w-40 h-40 object-cover rounded-lg mb-3 border-2 flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
                             style="border-color: var(--border-color);"
                             onclick="openImageModal('${p.image_url || placeholder}')">
                        <h3 class="text-xl font-bold text-center truncate w-full px-2" style="color: var(--text-main);">${p.name}</h3>
                        <p class="text-sm my-2">Precio: <span class="font-bold text-green-400">$${parseFloat(p.price).toFixed(2)}</span></p>
                        <div class="flex items-center space-x-4 mb-4">
                            <p class="text-2xl font-extrabold ${p.quantity < 5 ? 'text-red-400' : ''}" style="color: ${p.quantity >= 5 ? 'var(--text-accent)' : ''};">Disponibles: ${p.quantity}</p>
                            <button onclick="updateInventoryQuantity('${p.id}', -1, '${p.name}')" title="Restar Disponibles" class="quantity-btn ${p.quantity <= 0 ? 'opacity-50' : ''}" ${p.quantity <= 0 ? 'disabled' : ''}>&minus;</button>
                            <button onclick="updateInventoryQuantity('${p.id}', 1, '${p.name}')" title="Añadir Disponibles" class="quantity-btn">&#x2b;</button>
                        </div>
                        <div class="flex space-x-4 w-full justify-center text-sm">
                            <button onclick="openEditModal('${p.id}')" class="font-medium p-1" style="color: var(--text-accent-hover);">Editar</button>
                            <button onclick="deleteProduct('${p.id}', '${p.name}')" class="text-red-500 hover:text-red-400 font-medium p-1">Eliminar</button>
                        </div>`;
                    categoryGrid.appendChild(item);
                });
                
                listContainer.appendChild(header);
                listContainer.appendChild(categoryGrid);
            });
        };

        const renderSalesHistory = () => {
            const tbody = document.getElementById('sales-history-body');
            tbody.innerHTML = '';
            salesHistory.forEach(sale => {
                const date = new Date(sale.timestamp).toLocaleDateString();
                const currentStatus = sale.status || 'Pagado';
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-600 transition-colors';

                let statusColorClass = '';
                switch (currentStatus) {
                    case 'Pagado':
                        statusColorClass = 'bg-green-900/50 border-green-700 text-green-300';
                        break;
                    case 'Pendiente':
                        statusColorClass = 'bg-yellow-900/50 border-yellow-700 text-yellow-300';
                        break;
                    case 'Devuelto':
                        statusColorClass = 'bg-red-900/50 border-red-700 text-red-300';
                        break;
                    default:
                        statusColorClass = 'bg-gray-800 border-gray-600 text-white';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${sale.product_name} (x${sale.quantity || 1})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${sale.recipient}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400 font-bold">$${parseFloat(sale.price).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <select onchange="handleStatusChange(this, '${sale.id}')" class="status-select text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block w-full p-2 font-semibold transition-colors ${statusColorClass}">
                            <option value="Pagado" ${currentStatus === 'Pagado' ? 'selected' : ''}>Pagado</option>
                            <option value="Pendiente" ${currentStatus === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="Devuelto" ${currentStatus === 'Devuelto' ? 'selected' : ''}>Devuelto / Cancelado</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteSale('${sale.id}', '${sale.product_name}')" class="text-red-500 hover:text-red-400">Eliminar</button>
                    </td>
                `;
            });
            if (salesHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No hay ventas registradas.</td></tr>';
            }
        };

        const renderExpenses = () => {
            const tbody = document.getElementById('expenses-history-body');
            tbody.innerHTML = '';
            expensesHistory.forEach(expense => {
                const date = new Date(expense.timestamp).toLocaleDateString();
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-600 transition-colors';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${expense.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400 font-bold">$${parseFloat(expense.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="deleteExpense('${expense.id}', '${expense.description}')" class="text-red-500 hover:text-red-400">Eliminar</button>
                    </td>
                `;
            });
            if (expensesHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No hay gastos registrados.</td></tr>';
            }
        };

        const populateSaleCategoryDropdown = () => {
            const categorySelect = document.getElementById('sale-category');
            const productSelect = document.getElementById('sale-product-id');
            
            productSelect.innerHTML = '<option value="" disabled selected>Selecciona un producto</option>';
            productSelect.disabled = true;

            const categories = [...new Set(inventory.map(p => p.category || 'Sin Categoría'))].sort();

            categorySelect.innerHTML = '<option value="" disabled selected>Primero selecciona una categoría</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        };

        const populateSaleProductDropdown = (category) => {
            const productSelect = document.getElementById('sale-product-id');
            const priceInput = document.getElementById('sale-price');
            productSelect.innerHTML = '<option value="" disabled selected>Selecciona un producto</option>';
            priceInput.value = '0.00';

            if (!category) {
                productSelect.disabled = true;
                return;
            }

            const productsInCategory = inventory.filter(p => (p.category || 'Sin Categoría') === category);

            if (productsInCategory.length > 0) {
                productsInCategory.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.quantity} disponibles)`;
                    productSelect.appendChild(option);
                });
                productSelect.disabled = false;
            } else {
                productSelect.disabled = true;
            }
        };
        
        // --- MANEJADORES DE ACCIONES ---
        async function handleAddProduct(event) {
            event.preventDefault();
            const submitButton = document.getElementById('add-product-submit-button');
            const form = {
                name: document.getElementById('product-name').value.trim(),
                category: document.getElementById('product-category').value,
                quantity: parseInt(document.getElementById('product-quantity').value, 10),
                price: parseFloat(document.getElementById('product-price-initial').value),
                file: document.getElementById('product-image-file').files[0]
            };
            if (!form.name || !form.category || form.quantity <= 0 || form.price <= 0) {
                return showModal("Error", "Nombre, categoría, cantidad y precio son obligatorios.", "error");
            }
            
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 mr-3"></div><span>Guardando...</span></div>`;

            try {
                const imageData = form.file ? await fileToBase64(form.file, 512000) : null;
                const existing = inventory.find(p => p.name.toLowerCase() === form.name.toLowerCase() && p.category === form.category);
                let response; 
                
                if (existing) {
                    const newQty = existing.quantity + form.quantity;
                    response = await supabase.from('inventory').update({ quantity: newQty }).eq('id', existing.id).eq('user_id', currentUserId);
                    if (response.error) throw response.error; 
                    showModal("Cantidad Actualizada", `Se añadieron ${form.quantity} unidades a ${form.name}.`, "success");
                } else {
                    response = await supabase.from('inventory').insert([{ 
                        user_id: currentUserId, 
                        name: form.name, 
                        category: form.category,
                        quantity: form.quantity, 
                        price: form.price, 
                        image_url: imageData 
                    }]);
                    if (response.error) throw response.error;
                    showModal("Producto Agregado", `El producto '${form.name}' fue añadido con éxito.`, "success");
                }
                closeAddProductModal();
            } catch (e) { 
                const errorBody = e.message || "Error desconocido.";
                showModal("Error al Guardar Producto", `No se pudo completar la operación. Mensaje: ${errorBody}`, "error"); 
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Guardar Producto';
                await loadInventory(); 
            }
        }

        async function handleEditProduct(event) {
            event.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const newName = document.getElementById('edit-product-name').value.trim();
            const newCategory = document.getElementById('edit-product-category').value;
            const newPrice = parseFloat(document.getElementById('edit-product-price').value);

            if (!id || !newName || !newCategory || newPrice <= 0) {
                return showModal("Error", "Nombre, categoría y precio válidos son requeridos.", "error");
            }

            try {
                const { error } = await supabase.from('inventory').update({ 
                    name: newName, 
                    category: newCategory,
                    price: newPrice 
                }).eq('id', id).eq('user_id', currentUserId);
                if (error) throw error; 
                closeEditModal();
                showModal("Éxito", "Producto actualizado correctamente.", "success");
            } catch (e) { showModal("Error", e.message, "error"); }
            finally { await loadInventory(); }
        }

        async function handleLogoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const logoBase64 = await fileToBase64(file, 2097152);
                const { error } = await supabase.from('settings').upsert({ user_id: currentUserId, store_logo_url: logoBase64 }, { onConflict: 'user_id' });
                if (error) throw error;
                renderStoreLogo(logoBase64);
                showModal("Logo Actualizado", "El logo de la tienda se guardó con éxito.", "success");
            } catch (e) { showModal("Error de Logo", e.message, "error"); }
            finally { event.target.value = ''; }
        }

        async function handleRecordSale(event) {
            event.preventDefault();
            const productId = document.getElementById('sale-product-id').value;
            const saleQuantity = parseInt(document.getElementById('sale-quantity').value, 10);
            const recipient = document.getElementById('sale-recipient').value.trim();
            const price = parseFloat(document.getElementById('sale-price').value);
            const status = document.getElementById('sale-status').value;

            if (!productId || !recipient || !price || price <= 0 || saleQuantity <= 0) {
                return showModal("Datos Incompletos", "Categoría, producto, destinatario y precio son obligatorios.", "error");
            }
            
            const product = inventory.find(p => p.id === productId);

            if (!product) {
                return showModal("Error de Producto", "El producto seleccionado no es válido.", "error");
            }

            const productName = product.name;
            
            if (product.quantity < saleQuantity) {
                return showModal("Error de Cantidad", `Solo hay ${product.quantity} unidades de '${product.name}' disponibles. No puedes vender ${saleQuantity}.`, "error");
            }
            try {
                const { error: saleError } = await supabase.from('sales').insert([{ user_id: currentUserId, product_name: productName, product_id: productId, recipient, price, status: status, quantity: saleQuantity, timestamp: new Date() }]);
                if (saleError) throw saleError;
                if (productId) {
                    const { error: stockError } = await supabase.from('inventory').update({ quantity: product.quantity - saleQuantity }).eq('id', productId).eq('user_id', currentUserId);
                    if (stockError) throw stockError;
                }
                showModal("Venta Exitosa", `Venta de '${productName}' x${saleQuantity} registrada.`, "success");
                document.getElementById('record-sale-form').reset();
                populateSaleCategoryDropdown();
            } catch (e) { 
                showModal("Error de Venta", `No se pudo completar la transacción. Error: ${e.message}.`, "error"); 
            } finally { await loadAllData(false); }
        }

        async function handleRecordExpense(event) {
            event.preventDefault();
            const description = document.getElementById('expense-description').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);

            if (!description || !amount || amount <= 0) {
                return showModal("Datos Incompletos", "La descripción y un monto válido son obligatorios.", "error");
            }

            try {
                const { error } = await supabase.from('gastos').insert([{
                    user_id: currentUserId,
                    description: description,
                    amount: amount,
                    timestamp: new Date()
                }]);
                if (error) throw error;
                showModal("Gasto Registrado", `El gasto '${description}' por $${amount.toFixed(2)} fue guardado.`, "success");
                document.getElementById('record-expense-form').reset();
            } catch (e) {
                showModal("Error al Registrar Gasto", `No se pudo completar la operación. Error: ${e.message}`, "error");
            } finally {
                await loadAllData(false);
            }
        }

        async function updateSaleStatus(saleId, newStatus) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return showModal("Error", "Venta no encontrada.", "error");
            const oldStatus = sale.status || 'Pagado';
            const isInventorySale = sale.product_id;
            if (oldStatus === newStatus) return; 

            try {
                let stockChange = 0;
                const saleQuantity = sale.quantity || 1; 
                let product = null;
                if (isInventorySale) {
                    product = inventory.find(p => p.id === sale.product_id);
                    if (newStatus === 'Devuelto' && oldStatus !== 'Devuelto') {
                        stockChange = saleQuantity; 
                    } else if (oldStatus === 'Devuelto' && newStatus !== 'Devuelto') {
                        stockChange = -saleQuantity;
                        if (product && (product.quantity + stockChange) < 0) {
                            return showModal("Error de Cantidad", `No hay suficientes disponibles para cambiar de Devuelto a ${newStatus}. Disponibles: ${product.quantity}.`, "error");
                        }
                    }
                    if (stockChange !== 0 && product) {
                        const newQty = product.quantity + stockChange;
                        const { error: stockError } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', product.id).eq('user_id', currentUserId);
                        if (stockError) throw stockError;
                    }
                }
                const { error: updateError } = await supabase.from('sales').update({ status: newStatus }).eq('id', saleId).eq('user_id', currentUserId);
                if (updateError) throw updateError;
                const stockMsg = (stockChange !== 0 && isInventorySale) ? `(Disponibles ${stockChange > 0 ? 'restaurados' : 'reducidos'})` : '';
                showModal("Éxito", `Estado de '${sale.product_name}' actualizado a ${newStatus}. ${stockMsg}`, "success");
            } catch (e) {
                showModal("Error al Actualizar Estado", `No se pudo completar la operación. Error: ${e.message}`, "error");
            } finally {
                await loadAllData(false);
            }
        }

        window.updateInventoryQuantity = async (id, delta, name) => {
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            const newQty = product.quantity + delta;
            if (newQty < 0) {
                return showModal("Error de Cantidad", `La cantidad de '${name}' no puede ser negativa.`, "error");
            }
            try {
                const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id).eq('user_id', currentUserId);
                if (error) throw error;
            } catch (e) { 
                showModal("Error de Cantidad", e.message, "error"); 
            }
            finally { 
                await loadInventory(); 
            }
        };

        window.deleteProduct = (id, name) => {
            showModal("Confirmar Eliminación", `¿Estás seguro de que quieres eliminar '${name}'? Esta acción no se puede deshacer.`, "error");
            const confirmButton = document.getElementById('modal-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            confirmButton.textContent = 'Sí, Eliminar';
            confirmButton.onclick = async () => {
                try {
                    const { error } = await supabase.from('inventory').delete().eq('id', id).eq('user_id', currentUserId);
                    if (error) throw error;
                    showModal("Eliminado", `'${name}' fue eliminado con éxito.`, "success");
                } catch(e) { 
                    showModal("Error", `No se pudo eliminar el producto. ${e.message}`, "error"); 
                } finally {
                    await loadInventory();
                }
            };
            cancelButton.classList.remove('hidden');
        };

        window.deleteSale = (id, name) => {
            showModal("Confirmar Eliminación", `¿Seguro que quieres eliminar la venta de '${name}' del historial? Esta acción es permanente.`, "error");
            const confirmButton = document.getElementById('modal-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            confirmButton.textContent = 'Confirmar Eliminación';
            confirmButton.onclick = async () => {
                try {
                    const { error: deleteError } = await supabase.from('sales').delete().eq('id', id).eq('user_id', currentUserId);
                    if (deleteError) throw error;
                    showModal("Venta Eliminada", "La venta fue eliminada del historial.", "success");
                } catch(e) { 
                    showModal("Error", e.message, "error"); 
                } finally {
                    await loadAllData(false);
                }
            };
            cancelButton.classList.remove('hidden');
        };

        window.deleteExpense = (id, description) => {
            showModal("Confirmar Eliminación", `¿Seguro que quieres eliminar el gasto '${description}' del historial?`, "error");
            const confirmButton = document.getElementById('modal-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            confirmButton.textContent = 'Confirmar Eliminación';
            confirmButton.onclick = async () => {
                try {
                    const { error } = await supabase.from('gastos').delete().eq('id', id).eq('user_id', currentUserId);
                    if (error) throw error;
                    showModal("Gasto Eliminado", "El gasto fue eliminado permanentemente del historial.", "success");
                } catch(e) { showModal("Error", e.message, "error"); }
                finally {
                    await loadAllData(false);
                }
            };
            cancelButton.classList.remove('hidden');
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            initializeApp();
            document.getElementById('add-product-form').addEventListener('submit', handleAddProduct);
            document.getElementById('edit-product-form').addEventListener('submit', handleEditProduct);
            document.getElementById('record-sale-form').addEventListener('submit', handleRecordSale);
            document.getElementById('record-expense-form').addEventListener('submit', handleRecordExpense);
            document.getElementById('store-logo-img').addEventListener('click', () => document.getElementById('logo-file-input').click());
            document.getElementById('logo-file-input').addEventListener('change', handleLogoFileSelect);
            
            document.getElementById('sale-category').addEventListener('change', (event) => {
                populateSaleProductDropdown(event.target.value);
            });

            document.getElementById('sale-product-id').addEventListener('change', (event) => {
                const productId = event.target.value;
                const selectedProduct = inventory.find(p => p.id === productId);
                const priceInput = document.getElementById('sale-price');
                if (selectedProduct) {
                    priceInput.value = parseFloat(selectedProduct.price).toFixed(2);
                }
            });
        };
    </script>
</body>
</html>
