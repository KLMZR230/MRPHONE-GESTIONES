<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRPHONE PRODUCTOS Y VENTAS (Luxury Gold)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        input:focus, select:focus {
            --tw-ring-color: #d97706;
            border-color: #d97706;
        }
        .luxury-card {
            background-color: #1f2937;
            border: 1px solid #4b5563;
        }
        .quantity-btn {
            @apply bg-amber-700 text-white hover:bg-amber-600 transition-colors shadow-lg shadow-amber-900/50
                   rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold p-0.5;
        }
        #store-logo-img {
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <input type="file" id="logo-file-input" class="hidden" accept="image/*">

    <div id="app" class="flex-grow p-4 md:p-8">
        <header class="mb-6 md:mb-10 luxury-card p-4 rounded-xl shadow-2xl shadow-yellow-900/20">
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                <div class="flex items-center mb-4 sm:mb-0">
                    <div id="store-logo-container" title="Haz clic para cambiar el logo" class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center mr-4">
                        <img id="store-logo-img" src="https://placehold.co/64x64/d97706/1f2937?text=MR" alt="Store Logo"
                             class="w-full h-full object-cover rounded-full border-2 border-amber-500 transition-transform hover:scale-110">
                    </div>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-amber-500">
                        MRPHONE PRODUCTOS Y VENTAS
                    </h1>
                </div>

                <div class="flex flex-col items-start sm:items-end space-y-2">
                    <div id="daily-sales-summary" class="flex flex-col space-y-1 text-sm md:text-base font-semibold luxury-card p-2 rounded-lg border-amber-800/50">
                        <p>Vendido HOY: <span id="today-sold-total" class="text-amber-400">$0.00</span></p>
                        <p>Pagado HOY: <span id="today-paid-total" class="text-green-400">$0.00</span></p>
                    </div>
                    
                    <button onclick="openAddProductModal()" class="w-full sm:w-auto bg-amber-600 text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-amber-500 transition-colors shadow-lg shadow-amber-900/50 whitespace-nowrap">
                        Añadir Producto
                    </button>
                </div>
                </div>

            <nav class="flex justify-around space-x-2 border-b border-gray-700">
                <button onclick="changeView('inventory')" id="nav-inventory"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none">
                    Inventario
                </button>
                <button onclick="changeView('sales')" id="nav-sales"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none">
                    Registrar Venta
                </button>
                <button onclick="changeView('history')" id="nav-history"
                    class="py-2 px-3 sm:px-4 text-sm md:text-base font-medium text-center transition-all duration-200 border-b-4 border-transparent hover:border-amber-500 text-gray-400 hover:text-amber-400 focus:outline-none">
                    Historial de Ventas
                </button>
            </nav>
        </header>

        <main>
            <div id="loading-spinner" class="text-center p-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-amber-500 mx-auto"></div>
                <p class="mt-4 text-amber-500">Conectando a Supabase y sincronizando datos...</p>
            </div>
            <div id="error-message" class="text-center p-4 bg-red-900/50 text-red-300 rounded-lg shadow-md hidden"></div>

            <section id="view-inventory" class="view-content">
                <div class="p-6 luxury-card rounded-xl shadow-xl shadow-gray-900">
                    <h2 class="text-2xl font-bold text-amber-400 mb-6">Stock Actual</h2>
                    
                    <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full">Cargando inventario...</p>
                    </div>
                </div>
            </section>

            <section id="view-sales" class="view-content hidden">
                <div class="max-w-xl mx-auto p-6 luxury-card rounded-xl shadow-xl shadow-gray-900">
                    <h2 class="text-2xl font-bold text-amber-400 mb-6">Registrar Venta</h2>
                    <form id="record-sale-form" class="space-y-4">
                        <div>
                            <label for="sale-product-name" class="block text-sm font-medium text-gray-300">Nombre del Producto</label>
                            <input type="text" id="sale-product-name" required placeholder="Ej: iPhone 15 Pro Max o Reparación de Pantalla"
                                class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                        </div>
                        <div>
                            <label for="sale-quantity" class="block text-sm font-medium text-gray-300">Cantidad Vendida</label>
                            <input type="number" id="sale-quantity" required min="1" step="1" value="1"
                                class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                        </div>
                        <div>
                            <label for="sale-recipient" class="block text-sm font-medium text-gray-300">Destinatario / Cliente</label>
                            <input type="text" id="sale-recipient" required
                                class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                        </div>
                        <div>
                            <label for="sale-price" class="block text-sm font-medium text-gray-300">Precio de Venta ($)</label>
                            <input type="number" id="sale-price" required min="0.01" step="0.01" value="0.00"
                                class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                        </div>
                         <div>
                            <label for="sale-status" class="block text-sm font-medium text-gray-300">Estado de Pago</label>
                            <select id="sale-status" required 
                                class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                                <option value="Pagado">Pagado</option>
                                <option value="Pendiente">Pendiente</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="w-full bg-red-700 text-white p-3 rounded-lg font-bold hover:bg-red-800 transition-colors shadow-lg shadow-red-900/50">
                            Confirmar Venta
                        </button>
                    </form>
                </div>
            </section>

            <section id="view-history" class="view-content hidden">
                <div class="p-6 luxury-card rounded-xl shadow-xl shadow-gray-900">
                    <h2 class="text-2xl font-bold text-amber-400 mb-6">Historial de Transacciones</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr class="bg-gray-800">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-amber-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-amber-400 uppercase tracking-wider">Destinatario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-amber-400 uppercase tracking-wider">Precio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-amber-400 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-amber-400 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-amber-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-body" class="bg-gray-700 divide-y divide-gray-600 text-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all border-l-4 border-amber-500">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-amber-400"></h3>
            <p id="modal-body" class="text-gray-300 mb-4"></p>
            <button onclick="closeModal()" class="w-full py-2 rounded-lg text-gray-900 font-semibold transition-colors bg-amber-500 hover:bg-amber-400" id="modal-button"></button>
        </div>
    </div>

    <div id="edit-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all border-l-4 border-amber-500">
            <h3 class="text-2xl font-bold mb-4 text-amber-400">Editar Producto</h3>
            <form id="edit-product-form" class="space-y-4">
                <input type="hidden" id="edit-product-id">
                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-gray-300">Nombre</label>
                    <input type="text" id="edit-product-name" required class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                </div>
                <div>
                    <label for="edit-product-price" class="block text-sm font-medium text-gray-300">Precio ($)</label>
                    <input type="number" id="edit-product-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2 rounded-lg text-amber-400 font-semibold border border-amber-400 hover:bg-gray-700 transition-colors">Cancelar</button>
                    <button type="submit" class="flex-1 bg-amber-600 text-gray-900 p-3 rounded-lg font-bold hover:bg-amber-500 transition-colors shadow-lg shadow-amber-900/50">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-product-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all border-l-4 border-amber-500">
            <h3 class="text-2xl font-bold text-amber-400 mb-4">Añadir Nuevo Producto</h3>
            <form id="add-product-form" class="space-y-4">
                <div>
                    <label for="product-name" class="block text-sm font-medium text-gray-300">Nombre del Producto</label>
                    <input type="text" id="product-name" required class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                </div>
                <div>
                    <label for="product-price-initial" class="block text-sm font-medium text-gray-300">Precio Inicial ($)</label>
                    <input type="number" id="product-price-initial" required min="0.01" step="0.01" value="100.00" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                </div>
                <div>
                    <label for="product-quantity" class="block text-sm font-medium text-gray-300">Cantidad Inicial</label>
                    <input type="number" id="product-quantity" required min="1" value="1" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border">
                </div>
                <div>
                    <label for="product-image-file" class="block text-sm font-medium text-gray-300">Subir Foto (Opcional, máx 500KB)</label>
                    <input type="file" id="product-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-800 file:text-gray-900 hover:file:bg-amber-700">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeAddProductModal()" class="flex-1 py-2 rounded-lg text-amber-400 font-semibold border border-amber-400 hover:bg-gray-700 transition-colors">Cancelar</button>
                    <button type="submit" class="flex-1 bg-amber-600 text-gray-900 p-3 rounded-lg font-bold hover:bg-amber-500 transition-colors shadow-lg shadow-amber-900/50">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="status-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all border-l-4 border-amber-500">
            <h3 class="text-xl font-bold mb-4 text-amber-400">Cambiar Estado de Venta</h3>
            <p class="text-gray-300 mb-4">Selecciona el nuevo estado para la venta:</p>
            <input type="hidden" id="status-sale-id">
            <select id="new-sale-status" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500 p-3 border mb-4">
                <option value="Pagado">Pagado</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Devuelto">Devuelto</option>
            </select>
            <button onclick="confirmStatusChange()" class="w-full bg-amber-600 text-gray-900 p-3 rounded-lg font-bold hover:bg-amber-500 transition-colors shadow-lg shadow-amber-900/50">Confirmar</button>
            <button onclick="closeStatusModal()" class="w-full mt-2 py-2 rounded-lg text-amber-400 font-semibold border border-amber-400 hover:bg-gray-700 transition-colors">Cancelar</button>
        </div>
    </div>


    <script type="module">
        // --- CONFIGURACIÓN DE SUPABASE ---
        // CLAVES PROPORCIONADAS POR EL USUARIO
        const supabaseUrl = 'https://osqrggvtthczsxoovyps.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zcXJnZ3Z0dGhjenN4b292eXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDQ2OTUsImV4cCI6MjA3NTQ4MDY5NX0.yvCMoyMhuHkuKB_uA1P33rSC7U30MnixgTQNIEEp-dQ';
        
        let supabase = null, 
            inventory = [], 
            salesHistory = [], 
            pollingIntervalId = null;

        // ID COMPARTIDO: Todos los dispositivos usan este ID para leer/escribir.
        const PUBLIC_STORE_ID = 'public_store_id_mrphone'; 
        let currentUserId = null; 

        // --- FUNCIONES DE UTILIDAD (MODALES, VISTAS) ---
        window.showModal = (title, body, type = 'success') => {
            const modal = {
                title: document.getElementById('modal-title'),
                body: document.getElementById('modal-body'),
                button: document.getElementById('modal-button'),
                content: document.getElementById('modal-content'),
                container: document.getElementById('modal-container')
            };
            modal.title.textContent = title;
            modal.body.textContent = body;
            modal.container.classList.remove('hidden');
            modal.button.className = 'w-full py-2 rounded-lg font-semibold transition-colors';
            modal.content.className = 'bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all border-l-4';

            if (type === 'error') {
                modal.title.className = 'text-xl font-bold mb-3 text-red-400';
                modal.button.classList.add('bg-red-700', 'hover:bg-red-800', 'text-white');
                modal.content.classList.add('border-red-500');
                modal.button.textContent = 'Entendido';
            } else {
                modal.title.className = 'text-xl font-bold mb-3 text-amber-400';
                modal.button.classList.add('bg-amber-500', 'hover:bg-amber-400', 'text-gray-900');
                modal.content.classList.add('border-amber-500');
                modal.button.textContent = 'Cerrar';
            }
        };
        window.closeModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-button').textContent = 'Cerrar';
            document.getElementById('modal-button').onclick = closeModal;
        }

        window.openEditModal = (id) => {
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = parseFloat(product.price).toFixed(2);
            document.getElementById('edit-modal-container').classList.remove('hidden');
        };
        window.closeEditModal = () => document.getElementById('edit-modal-container').classList.add('hidden');
        window.openAddProductModal = () => document.getElementById('add-product-modal-container').classList.remove('hidden');
        window.closeAddProductModal = () => document.getElementById('add-product-modal-container').classList.add('hidden');

        window.openStatusModal = (id, currentStatus) => {
            document.getElementById('status-sale-id').value = id;
            const select = document.getElementById('new-sale-status');
            select.value = currentStatus;
            document.getElementById('status-modal-container').classList.remove('hidden');
        };
        window.closeStatusModal = () => document.getElementById('status-modal-container').classList.add('hidden');

        window.confirmStatusChange = async () => {
            const saleId = document.getElementById('status-sale-id').value;
            const newStatus = document.getElementById('new-sale-status').value;
            await updateSaleStatus(saleId, newStatus);
            closeStatusModal();
        };

        window.changeView = (viewId) => {
            document.querySelectorAll('.view-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('text-amber-500', 'border-amber-500');
                b.classList.add('text-gray-400', 'border-transparent');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById(`nav-${viewId}`).classList.add('text-amber-500', 'border-amber-500');
        };

        const fileToBase64 = (file, maxSize) => new Promise((resolve, reject) => {
            if (!file) return resolve(null);
            // Límite de 2MB
            if (file.size > maxSize) return reject(`Archivo demasiado grande. Límite: ${(maxSize / 1048576).toFixed(0)} MB.`); 
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject("Error al leer archivo.");
        });

        // --- INICIALIZACIÓN Y GESTIÓN DEL ID DE TIENDA COMPARTIDO ---

        const initializeApp = () => {
            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                // Forzamos el uso del ID de tienda pública para sincronización universal
                currentUserId = PUBLIC_STORE_ID; 
                localStorage.setItem('mrphone_user_id', currentUserId); // Guardamos la ID para futuras cargas

                startPolling(true); // Iniciar la carga de datos
            } catch (error) {
                document.getElementById('error-message').textContent = `Error de Conexión: ${error.message}`;
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        };

        const startPolling = (initialLoad = false) => {
            clearInterval(pollingIntervalId);
            loadAllData(initialLoad);
            // Sincronización continua cada 5 segundos
            pollingIntervalId = setInterval(() => loadAllData(false), 5000); 
        };

        async function loadAllData(showSpinner = false) {
            if (!supabase || !currentUserId) return;
            if (showSpinner) document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                await Promise.all([loadInventory(), loadSalesHistory(), loadSettings()]); 
                renderSalesSummary();
            } catch (e) { 
                console.error("Error cargando datos:", e);
                // Si la migración falló por alguna razón, este mensaje ayuda a diagnosticar
                document.getElementById('error-message').textContent = `Error al cargar datos. Mensaje: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden'); 
            }
            finally {
                if (showSpinner) document.getElementById('loading-spinner').classList.add('hidden');
                if (!document.querySelector('.view-content:not(.hidden)')) changeView('inventory');
            }
        }
        const loadInventory = async () => {
            const { data, error } = await supabase.from('inventory').select('*').eq('user_id', currentUserId).order('created_at', { ascending: false });
            if (error) throw error;
            inventory = (data || []).map(p => ({ ...p, price: p.price ?? 0.01 }));
            renderInventoryList();
        };
        
        const loadSalesHistory = async () => {
            const { data, error } = await supabase.from('sales').select('*').eq('user_id', currentUserId).order('timestamp', { ascending: false });
            if (error) throw error;
            salesHistory = data || [];
            renderSalesHistory();
        };
        const loadSettings = async () => {
            const { data, error } = await supabase.from('settings').select('store_logo_url').eq('user_id', currentUserId).single();
            // PGRST116 = No Rows, lo cual es normal si no ha cargado logo
            if (error && error.code !== 'PGRST116') { console.error("Error cargando settings:", error); } 
            if (data?.store_logo_url) renderStoreLogo(data.store_logo_url);
        };

        // --- RENDERIZACIÓN ---
        const renderStoreLogo = (url) => {
            const logoImg = document.getElementById('store-logo-img');
            const placeholder = "https://placehold.co/64x64/d97706/1f2937?text=MR";
            logoImg.src = url || placeholder;
            logoImg.onerror = () => { logoImg.src = placeholder; };
        };
        
        const renderSalesSummary = () => {
            const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric' });
            
            const todaySales = salesHistory.filter(sale => {
                const saleDate = new Date(sale.timestamp).toLocaleDateString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric' });
                return saleDate === today;
            });

            const todaySoldTotal = todaySales.reduce((sum, sale) => sum + parseFloat(sale.price || 0), 0);
            const todayPaidTotal = todaySales
                .filter(sale => (sale.status || 'Pagado') === 'Pagado')
                .reduce((sum, sale) => sum + parseFloat(sale.price || 0), 0);

            document.getElementById('today-sold-total').textContent = `$${todaySoldTotal.toFixed(2)}`;
            document.getElementById('today-paid-total').textContent = `$${todayPaidTotal.toFixed(2)}`;
        };

        const getStatusBadge = (status) => {
            const s = status || 'Pagado'; 
            let colorClass = 'bg-gray-600';
            let colorText = 'text-white';

            switch (s) {
                case 'Pagado':
                    colorClass = 'bg-green-700';
                    break;
                case 'Pendiente':
                    colorClass = 'bg-yellow-700';
                    break;
                case 'Devuelto':
                    colorClass = 'bg-red-700';
                    break;
            }
            return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${colorClass} ${colorText}">${s}</span>`;
        };
        
        const renderInventoryList = () => {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            if (inventory.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center col-span-full">No hay productos en el inventario.</p>';
                return;
            }
            inventory.forEach(p => {
                const initials = p.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                const placeholder = `https://placehold.co/150x150/d97706/1f2937?text=${initials}&font=inter`;
                const item = document.createElement('div');
                
                item.className = 'flex flex-col items-center p-4 luxury-card rounded-xl shadow-lg hover:shadow-amber-900/40 transition-shadow duration-300 transform hover:scale-[1.01]';
                
                item.innerHTML = `
                    <img src="${p.image_url || placeholder}" onerror="this.src='${placeholder}'" alt="${p.name}" 
                         class="w-32 h-32 object-cover rounded-lg mb-3 border-2 border-amber-500/50 flex-shrink-0">
                    
                    <h3 class="text-xl font-bold text-white text-center truncate w-full px-2">${p.name}</h3>
                    <p class="text-sm text-gray-400 mb-4">Precio: <span class="text-green-400 font-bold">$${parseFloat(p.price).toFixed(2)}</span></p>

                    <div class="flex items-center space-x-4 mb-4">
                        <p class="text-2xl font-extrabold ${p.quantity < 5 ? 'text-red-400' : 'text-amber-400'}">Stock: ${p.quantity}</p>
                        <button onclick="updateInventoryQuantity('${p.id}', -1, '${p.name}')" title="Restar Stock" class="quantity-btn ${p.quantity<=0 ? 'opacity-50' : ''}" ${p.quantity<=0 ? 'disabled' : ''}>&minus;</button>
                        <button onclick="updateInventoryQuantity('${p.id}', 1, '${p.name}')" title="Añadir Stock" class="quantity-btn">&#x2b;</button>
                    </div>

                    <div class="flex space-x-4 w-full justify-center text-sm">
                        <button onclick="openEditModal('${p.id}')" class="text-amber-500 hover:text-amber-300 font-medium p-1">Editar</button>
                        <button onclick="deleteProduct('${p.id}', '${p.name}')" class="text-red-500 hover:text-red-400 font-medium p-1">Eliminar</button>
                    </div>`;
                list.appendChild(item);
            });
        };

        const renderSalesHistory = () => {
            const tbody = document.getElementById('sales-history-body');
            tbody.innerHTML = '';
            salesHistory.forEach(sale => {
                const date = new Date(sale.timestamp).toLocaleDateString();
                const statusBadge = getStatusBadge(sale.status);
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-600 transition-colors';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${sale.product_name} (x${sale.quantity || 1})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${sale.recipient}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400 font-bold">$${parseFloat(sale.price).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openStatusModal('${sale.id}', '${sale.status || 'Pagado'}')" class="text-amber-500 hover:text-amber-400 mr-3">Estado</button>
                        <button onclick="deleteSale('${sale.id}', '${sale.product_name}')" class="text-red-500 hover:text-red-400">Eliminar</button>
                    </td>
                `;
            });
            if (salesHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No hay ventas registradas.</td></tr>';
            }
        };
        
        // --- MANEJADORES DE ACCIONES ---
        async function handleAddProduct(event) {
            event.preventDefault();
            const form = {
                name: document.getElementById('product-name').value.trim(),
                quantity: parseInt(document.getElementById('product-quantity').value, 10),
                price: parseFloat(document.getElementById('product-price-initial').value),
                file: document.getElementById('product-image-file').files[0]
            };
            if (!form.name || form.quantity <= 0 || form.price <= 0) return showModal("Error", "Nombre, cantidad y precio son obligatorios.", "error");
            
            try {
                const imageData = form.file ? await fileToBase64(form.file, 512000) : null;
                const existing = inventory.find(p => p.name.toLowerCase() === form.name.toLowerCase());

                let response; 

                if (existing) {
                    const newQty = existing.quantity + form.quantity;
                    response = await supabase.from('inventory').update({ quantity: newQty }).eq('id', existing.id).eq('user_id', currentUserId);
                    if (response.error) throw response.error; 
                    showModal("Stock Actualizado", `Se añadieron ${form.quantity} unidades a ${form.name}.`, "success");
                } else {
                    response = await supabase.from('inventory').insert([{ 
                        user_id: currentUserId, 
                        name: form.name, 
                        quantity: form.quantity, 
                        price: form.price, 
                        image_url: imageData
                    }]);
                    if (response.error) throw response.error;
                    showModal("Producto Agregado", `El producto '${form.name}' fue añadido con éxito.`, "success");
                }
                
                closeAddProductModal();
                document.getElementById('add-product-form').reset();

            } catch (e) { 
                const errorBody = e.message || "Error desconocido.";
                showModal("Error al Guardar Producto", `No se pudo completar la operación. Mensaje: ${errorBody}`, "error"); 
            }
            finally { 
                await loadInventory(); 
            }
        }

        async function handleEditProduct(event) {
            event.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const newName = document.getElementById('edit-product-name').value.trim();
            const newPrice = parseFloat(document.getElementById('edit-product-price').value);
            if (!id || !newName || newPrice <= 0) return showModal("Error", "Nombre y precio válidos son requeridos.", "error");

            try {
                const { error } = await supabase.from('inventory').update({ name: newName, price: newPrice }).eq('id', id).eq('user_id', currentUserId);
                if (error) throw error; 
                closeEditModal();
                showModal("Éxito", "Producto actualizado correctamente.", "success");
            } catch (e) { showModal("Error", e.message, "error"); }
            finally { await loadInventory(); }
        }

        async function handleLogoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const logoBase64 = await fileToBase64(file, 2097152); // Límite de 2MB
                // Usamos upsert para crear o actualizar la fila de settings con nuestro ID compartido
                const { error } = await supabase.from('settings').upsert({ user_id: currentUserId, store_logo_url: logoBase64 }, { onConflict: 'user_id' });
                if (error) throw error;
                renderStoreLogo(logoBase64);
                showModal("Logo Actualizado", "El logo de la tienda se guardó con éxito.", "success");
            } catch (e) { showModal("Error de Logo", e.message, "error"); }
            finally { event.target.value = ''; }
        }

        async function handleRecordSale(event) {
            event.preventDefault();
            const productName = document.getElementById('sale-product-name').value.trim();
            const saleQuantity = parseInt(document.getElementById('sale-quantity').value, 10);
            const recipient = document.getElementById('sale-recipient').value.trim();
            const price = parseFloat(document.getElementById('sale-price').value);
            const status = document.getElementById('sale-status').value;

            if (!productName || !recipient || !price || price <= 0 || saleQuantity <= 0) {
                return showModal("Datos Incompletos", "Todos los campos son obligatorios.", "error");
            }
            
            const product = inventory.find(p => p.name.toLowerCase() === productName.toLowerCase());

            let productId = null;
            
            if (product) {
                if (product.quantity < saleQuantity) {
                    return showModal("Error de Stock", `Solo hay ${product.quantity} unidades de '${product.name}' en stock. No puedes vender ${saleQuantity}.`, "error");
                }
                productId = product.id;
            }

            try {
                // 1. Registrar la venta
                const { error: saleError } = await supabase.from('sales').insert([{ 
                    user_id: currentUserId, 
                    product_name: productName, 
                    product_id: productId, 
                    recipient, 
                    price, 
                    status: status, 
                    quantity: saleQuantity, 
                    timestamp: new Date() 
                }]);
                if (saleError) throw saleError;
                
                // 2. Descontar el stock (solo si el producto fue encontrado)
                if (productId) {
                    const { error: stockError } = await supabase.from('inventory').update({ quantity: product.quantity - saleQuantity }).eq('id', productId).eq('user_id', currentUserId);
                    if (stockError) throw stockError;
                }
                
                showModal("Venta Exitosa", `Venta de '${productName}' x${saleQuantity} registrada.`, "success");
                document.getElementById('record-sale-form').reset();
            } catch (e) { 
                showModal("Error de Venta", `No se pudo completar la transacción. Error: ${e.message}.`, "error"); 
            }
            finally { 
                await loadAllData(false); 
            }
        }

        async function updateSaleStatus(saleId, newStatus) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return showModal("Error", "Venta no encontrada.", "error");

            const oldStatus = sale.status || 'Pagado';
            const isInventorySale = sale.product_id;

            if (oldStatus === newStatus) return; 

            try {
                let stockChange = 0;
                const saleQuantity = sale.quantity || 1; 
                let product = null;

                if (isInventorySale) {
                    product = inventory.find(p => p.id === sale.product_id);
                    if (!product) { console.warn("Producto no encontrado en inventario local."); }

                    if (newStatus === 'Devuelto' && oldStatus !== 'Devuelto') {
                        stockChange = saleQuantity; 
                    } 
                    else if (oldStatus === 'Devuelto' && newStatus !== 'Devuelto') {
                        stockChange = -saleQuantity;
                        
                        if (product && (product.quantity + stockChange) < 0) {
                            return showModal("Error de Stock", `No hay suficiente stock para cambiar de Devuelto a ${newStatus}. Stock actual: ${product.quantity}.`, "error");
                        }
                    }

                    if (stockChange !== 0 && product) {
                        const newQty = product.quantity + stockChange;
                        const { error: stockError } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', product.id).eq('user_id', currentUserId);
                        if (stockError) throw stockError;
                    }
                }

                const { error: updateError } = await supabase.from('sales').update({ status: newStatus }).eq('id', saleId).eq('user_id', currentUserId);
                if (updateError) throw updateError;
                
                const stockMsg = (stockChange !== 0 && isInventorySale) ? `(Stock ${stockChange > 0 ? 'restaurado' : 'reducido'}).` : '';
                showModal("Éxito", `Estado de '${sale.product_name}' actualizado a ${newStatus}. ${stockMsg}`, "success");

            } catch (e) {
                showModal("Error al Actualizar Estado", `No se pudo completar la operación. Error: ${e.message}`, "error");
            } finally {
                await loadAllData(false);
            }
        }

        window.updateInventoryQuantity = async (id, delta, name) => {
            const product = inventory.find(p => p.id === id);
            if (!product) return;

            const newQty = product.quantity + delta;
            if (newQty < 0) {
                return showModal("Error de Stock", `El stock de '${name}' no puede ser negativo.`, "error");
            }
            
            try {
                const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id).eq('user_id', currentUserId);
                if (error) throw error;
                
                showModal("Stock Actualizado", `El stock de '${name}' ha sido modificado en ${delta}. Nuevo stock: ${newQty}`, "success");

            } catch (e) { 
                showModal("Error de Stock", e.message, "error"); 
            }
            finally { 
                await loadInventory(); 
            }
        };

        window.deleteProduct = (id, name) => {
            showModal("Confirmar", `¿Seguro que quieres eliminar '${name}'?`, "error");
            document.getElementById('modal-button').textContent = 'Confirmar Eliminación';
            document.getElementById('modal-button').onclick = async () => {
                try {
                    const { error } = await supabase.from('inventory').delete().eq('id', id).eq('user_id', currentUserId);
                    if (error) throw error;
                    showModal("Eliminado", `'${name}' fue eliminado.`, "success");
                } catch(e) { showModal("Error", e.message, "error"); }
                finally {
                    await loadInventory();
                    closeModal(); 
                }
            };
        };

        window.deleteSale = (id, name) => {
            showModal("Confirmar Eliminación", `¿Seguro que quieres eliminar completamente la venta de '${name}' del historial? **Esta acción NO modifica el stock.**`, "error");
            document.getElementById('modal-button').textContent = 'Confirmar Eliminación';
            document.getElementById('modal-button').onclick = async () => {
                try {
                    const { error: deleteError } = await supabase.from('sales').delete().eq('id', id).eq('user_id', currentUserId);
                    if (deleteError) throw deleteError;
                    showModal("Venta Eliminada", "La venta fue eliminada permanentemente del historial.", "success");
                } catch(e) { showModal("Error", e.message, "error"); }
                finally {
                    await loadAllData(false);
                    closeModal(); 
                }
            };
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            initializeApp();
            document.getElementById('add-product-form').addEventListener('submit', handleAddProduct);
            document.getElementById('edit-product-form').addEventListener('submit', handleEditProduct);
            document.getElementById('record-sale-form').addEventListener('submit', handleRecordSale);
            document.getElementById('store-logo-img').addEventListener('click', () => document.getElementById('logo-file-input').click());
            document.getElementById('logo-file-input').addEventListener('change', handleLogoFileSelect);
        };
    </script>
</body>
</html>
